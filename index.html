<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Viral Finder - 소재 발굴기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            input: '#334155'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            border-color: rgba(14, 165, 233, 0.3);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #38bdf8;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            background: rgba(30, 41, 59, 0.95);
            border-left: 4px solid #38bdf8;
            color: white;
            padding: 16px 24px;
            margin-top: 10px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out forwards;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Markdown Styles */
        .prose h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; color: #93c5fd; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose p { margin-bottom: 1rem; }
        .prose strong { color: #e2e8f0; font-weight: 600; }
    </style>
</head>
<body class="min-h-screen flex flex-col relative overflow-x-hidden">

    <!-- Background Effects -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-600/20 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-600/20 rounded-full blur-[120px]"></div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-50 border-b border-white/10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="resetToHome()">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-bolt text-white text-lg"></i>
                </div>
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                    YouTube Viral Finder
                </h1>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Navigation Tabs -->
                <div class="flex bg-white/5 rounded-lg p-1 border border-white/10">
                    <button id="tabSearch" onclick="showSearchTab()" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-white bg-white/10 shadow-sm">
                        <i class="fa-solid fa-magnifying-glass mr-2"></i>검색
                    </button>
                    <button id="tabTrending" onclick="showTrendingTab()" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">
                        <i class="fa-solid fa-fire mr-2"></i>최근 인기 동영상
                    </button>
                    <button id="tabFavorites" onclick="showFavoritesTab()" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">
                        <i class="fa-solid fa-heart mr-2"></i>즐겨찾기 피드
                    </button>
                </div>

                <!-- API Settings Button -->
                <button onclick="openSettings()" class="h-10 px-4 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 flex items-center justify-center text-gray-400 hover:text-yellow-400 transition-all gap-2" title="API 키 설정">
                    <i class="fa-solid fa-key"></i> <span class="text-sm font-medium">API 설정</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-6 py-12">
        
        <!-- SEARCH TAB CONTENT -->
        <div id="searchTabContent">
            <!-- Search Section -->
            <section class="max-w-4xl mx-auto mb-16 text-center animate-fade-in">
                
                
                
                <div class="relative max-w-3xl mx-auto group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                    <div class="relative bg-dark-card rounded-xl border border-white/10 p-2 shadow-2xl">
                        
                        <!-- Search Input -->
                        <div class="flex items-center border-b border-white/5 pb-2 mb-2">
                            <i class="fa-solid fa-magnifying-glass text-gray-400 ml-4 text-lg"></i>
                            <input type="text" id="searchInput" 
                                class="w-full bg-transparent border-none text-white px-4 py-3 focus:outline-none text-lg placeholder-gray-500"
                                placeholder="검색 키워드를 입력하세요 (예: 재테크, 요리, 운동)..."
                                onkeypress="handleEnter(event)">
                            <button onclick="searchVideos()" 
                                class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 shadow-lg shadow-blue-600/20 whitespace-nowrap">
                                <span>검색</span>
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>

                        <!-- Filters -->
                        <div class="flex flex-wrap items-center gap-6 px-6 py-4 text-sm bg-black/20 border-t border-white/5">
                            
                            <!-- Duration Filter -->
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400"><i class="fa-regular fa-clock mr-1"></i>길이:</span>
                                <select id="durationFilter" onchange="saveFilters()" class="bg-white/5 border border-white/10 rounded px-3 py-1.5 text-white focus:outline-none focus:border-blue-500 hover:bg-white/10 transition-colors">
                                    <option value="any" class="bg-slate-800">전체</option>
                                    <option value="short" class="bg-slate-800">쇼츠 (3분 미만)</option>
                                    <option value="medium" class="bg-slate-800">일반 (3분~20분)</option>
                                    <option value="long" class="bg-slate-800">롱폼 (20분 이상)</option>
                                </select>
                            </div>
                            
                            <div class="w-px h-8 bg-white/10"></div>

                            <!-- Date Filter -->
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400"><i class="fa-regular fa-calendar mr-1"></i>기간:</span>
                                <select id="dateFilter" onchange="saveFilters()" class="bg-white/5 border border-white/10 rounded px-3 py-1.5 text-white focus:outline-none focus:border-blue-500 hover:bg-white/10 transition-colors">
                                    <option value="any" class="bg-slate-800">전체</option>
                                    <option value="1d" class="bg-slate-800">최근 1일</option>
                                    <option value="7d" class="bg-slate-800">최근 7일</option>
                                    <option value="15d" class="bg-slate-800">최근 15일</option>
                                    <option value="30d" class="bg-slate-800">최근 1달</option>
                                    <option value="90d" class="bg-slate-800">최근 3개월</option>
                                </select>
                            </div>

                            <div class="w-px h-8 bg-white/10"></div>

                            <!-- Ratio Slider -->
                            <div class="flex items-center gap-4 flex-grow min-w-[200px]">
                                <span class="text-gray-400 whitespace-nowrap"><i class="fa-solid fa-chart-line mr-1"></i>최소 성과율:</span>
                                <div class="flex-grow flex flex-col gap-1">
                                    <div class="flex justify-between text-xs px-1">
                                        <span class="text-gray-500">0%</span>
                                        <span id="ratioValueLabel" class="text-blue-400 font-bold transition-all">일반 (0% 이상)</span>
                                        <span class="text-gray-500">1000%</span>
                                    </div>
                                    <input type="range" id="ratioSlider" min="0" max="100" value="0" step="5" 
                                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400 transition-all"
                                        oninput="updateRatioLabel(this.value)" onchange="saveFilters()">
                                </div>
                            </div>

                            <div class="w-px h-8 bg-white/10"></div>

                            <!-- View Count Filter -->
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400"><i class="fa-solid fa-eye mr-1"></i>최소 조회수:</span>
                                <select id="viewCountFilter" onchange="saveFilters()" class="bg-white/5 border border-white/10 rounded px-3 py-1.5 text-white focus:outline-none focus:border-blue-500 hover:bg-white/10 transition-colors">
                                    <option value="0" class="bg-slate-800">제한 없음</option>
                                    <option value="1000" class="bg-slate-800">1천 이상</option>
                                    <option value="5000" class="bg-slate-800">5천 이상</option>
                                    <option value="10000" class="bg-slate-800">1만 이상</option>
                                    <option value="50000" class="bg-slate-800">5만 이상</option>
                                    <option value="100000" class="bg-slate-800">10만 이상</option>
                                    <option value="500000" class="bg-slate-800">50만 이상</option>
                                    <option value="1000000" class="bg-slate-800">100만 이상</option>
                                </select>
                            </div>

                        </div>

                        <!-- Recent Searches -->
                        <div id="recentSearchSection" class="hidden px-6 py-3 bg-black/20 border-t border-white/5">
                            <div class="flex items-start md:items-center gap-3 text-sm">
                                <span class="text-gray-400 whitespace-nowrap mt-1 md:mt-0"><i class="fa-solid fa-clock-rotate-left mr-1"></i>최근 검색:</span>
                                <div id="recentSearchList" class="flex flex-wrap gap-2">
                                    <!-- Recent keywords injected here -->
                                </div>
                                <button onclick="clearRecentSearches()" class="ml-auto text-xs text-gray-500 hover:text-red-400 whitespace-nowrap mt-1 md:mt-0" title="기록 삭제">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Recommended Keywords -->
                        <div id="keywordRecommendations" class="hidden px-6 py-3 bg-black/30 border-t border-white/5 animate-fade-in">
                            <div class="flex items-start md:items-center gap-3 text-sm">
                                <span class="text-blue-400 whitespace-nowrap mt-1 md:mt-0"><i class="fa-solid fa-lightbulb mr-1"></i>추천 키워드:</span>
                                <div id="keywordList" class="flex flex-wrap gap-2">
                                    <!-- Keywords injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Loading State -->
            <div id="searchLoader" class="hidden flex flex-col items-center justify-center py-20">
                <div class="w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                <p class="text-gray-400 animate-pulse">데이터를 수집하고 분석 중입니다...</p>
            </div>

            <!-- Results Section -->
            <section id="resultsSection" class="hidden animate-slide-up">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h3 class="text-2xl font-bold text-white mb-2">검색 결과</h3>
                        <p class="text-gray-400 text-sm">설정한 필터 조건에 맞는 영상들을 보여줍니다.</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-500">
                            <span id="resultCount">0</span>개의 영상 발견
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400 text-sm">정렬:</span>
                            <select id="sortFilter" onchange="saveSortAndApply()" class="bg-white/5 border border-white/10 rounded px-3 py-1.5 text-white text-sm focus:outline-none focus:border-blue-500 hover:bg-white/10 transition-colors">
                                <option value="views" class="bg-slate-800">조회수 높은순</option>
                                <option value="ratio" class="bg-slate-800">성과율 높은순</option>
                                <option value="recent" class="bg-slate-800">최근 업로드순</option>
                                <option value="subs" class="bg-slate-800">구독자 많은순</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Video Cards will be injected here -->
                </div>
            </section>
        </div>

        <!-- FAVORITES TAB CONTENT -->
        <div id="favoritesTabContent" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">즐겨찾기 채널 피드</h2>
                        <p class="text-gray-400">저장한 채널들의 최신 영상을 모아봅니다.</p>
                    </div>
                    <button onclick="loadFavoritesFeed(true)" class="bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-lg border border-white/10 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-rotate-right"></i> 새로고침
                    </button>
                </div>

                <!-- Favorites List (Horizontal) -->
                <div id="favoritesList" class="flex gap-4 overflow-x-auto pb-4 mb-8 custom-scrollbar">
                    <!-- Favorite Channels injected here -->
                </div>

                <!-- Feed Grid -->
                <div id="feedLoader" class="hidden flex flex-col items-center justify-center py-20">
                    <div class="w-12 h-12 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-400 animate-pulse">최신 영상을 불러오는 중...</p>
                </div>

                <div id="feedGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Feed Videos injected here -->
                </div>
                
                <div id="emptyFeedMessage" class="hidden text-center py-20 text-gray-500">
                    <i class="fa-regular fa-heart text-4xl mb-4 opacity-50"></i>
                    <p>즐겨찾기한 채널이 없습니다.<br>검색 결과에서 하트 아이콘을 눌러 채널을 추가해보세요.</p>
                </div>
            </div>
        </div>

        <!-- TRENDING TAB CONTENT -->
        <div id="trendingTabContent" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">최근 인기 동영상</h2>
                        <p class="text-gray-400">시니어 드라마 등 지정된 키워드 조합으로 최근 3주간 조회수 1만 이상인 인기 영상을 모아봅니다.</p>
                    </div>
                    <button onclick="loadTrendingFeed(true)" class="bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-lg border border-white/10 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-rotate-right"></i> 새로고침
                    </button>
                </div>

                <!-- Keyword Input -->
                <div class="flex gap-2 mb-4">
                    <input type="text" id="trendingKeywordInput" placeholder="추가할 키워드 입력 (예: 은퇴 준비)" 
                        class="bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 flex-grow"
                        onkeypress="handleTrendingInputKey(event)">
                    <button onclick="addCustomTrendingKeyword()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-colors whitespace-nowrap">
                        추가
                    </button>
                </div>

                <!-- Keyword Chips (selected) -->
                <div id="trendingKeywordsList" class="flex gap-4 overflow-x-auto pb-4 mb-8 custom-scrollbar"></div>

                <!-- Recommended Keywords -->
                <div id="trendingKeywordRecommendations" class="hidden px-6 py-3 bg-black/30 border-t border-white/5 animate-fade-in mb-8 rounded-lg">
                    <div class="flex items-start md:items-center gap-3 text-sm">
                        <span class="text-blue-400 whitespace-nowrap mt-1 md:mt-0"><i class="fa-solid fa-lightbulb mr-1"></i>추천 키워드:</span>
                        <div id="trendingRecommendedList" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="trendingLoader" class="hidden flex flex-col items-center justify-center py-20">
                    <div class="w-12 h-12 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-400 animate-pulse">인기 영상을 불러오는 중...</p>
                </div>

                <!-- Video Grid -->
                <div id="trendingGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

                <!-- Empty Message -->
                <div id="emptyTrendingMessage" class="hidden text-center py-20 text-gray-500">
                    <i class="fa-regular fa-fire text-4xl mb-4 opacity-50"></i>
                    <p>조건에 맞는 인기 영상이 없습니다.<br>키워드와 필터를 조정해 보세요.</p>
                </div>

                <!-- Auto‑update notice -->
                <p class="text-xs text-gray-500 text-center mt-8">※ 최신 리스트는 6시간마다 자동 업데이트됩니다.</p>
            </div>
        </div>

    </main>

    <!-- Analysis Modal -->
    <div id="analysisModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-[#1e293b] w-full max-w-6xl max-h-[90vh] rounded-2xl shadow-2xl border border-white/10 flex flex-col pointer-events-auto overflow-hidden transform transition-all scale-95 opacity-0" id="modalContent">
                
                <!-- Modal Header -->
                <div class="p-6 border-b border-white/10 flex justify-between items-center bg-[#0f172a]">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-wand-magic-sparkles text-purple-400"></i>
                        <h2 class="text-xl font-bold text-white">AI 영상 분석</h2>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>
                    
                <!-- Modal Body (Two Column Layout) -->
                <div class="flex-1 overflow-y-auto">
                    <div class="flex flex-col lg:flex-row gap-6 p-6">
                    
                    <!-- Left Column: Analysis & Ideas -->
                    <div class="w-full lg:w-5/12 flex-shrink-0 space-y-6">
                        
                        <!-- Video Info -->
                        <div class="flex gap-4 items-start">
                            <img id="modalThumbnail" src="" alt="Thumbnail" class="w-32 h-20 object-cover rounded-lg shadow-md flex-shrink-0">
                            <div>
                                <h4 id="modalTitle" class="font-bold text-white text-sm line-clamp-2 mb-1"></h4>
                                <div class="flex gap-2 text-xs text-gray-400">
                                    <span id="modalChannel"></span>
                                    <span class="text-green-400 font-bold" id="modalRatio"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Initial Loading -->
                        <div id="aiLoader" class="flex flex-col items-center justify-center py-20">
                            <div class="w-12 h-12 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin mb-4"></div>
                            <p class="text-gray-400 animate-pulse">AI가 영상을 분석하고 있습니다...</p>
                        </div>

                        <!-- Analysis Result -->
                        <div id="analysisResult" class="hidden space-y-6">
                            <!-- Summary & Reactions -->
                            <div class="bg-white/5 rounded-xl p-4 border border-white/5">
                                <h5 class="text-blue-400 font-bold text-sm mb-2"><i class="fa-solid fa-align-left mr-2"></i>영상 요약</h5>
                                <p id="aiSummary" class="text-gray-300 text-sm mb-4"></p>
                                
                                <h5 class="text-green-400 font-bold text-sm mb-2"><i class="fa-regular fa-face-smile mr-2"></i>시청자 반응</h5>
                                <p id="aiReactions" class="text-gray-300 text-sm"></p>
                            </div>

                            <!-- Ideas List -->
                            <div>
                                <h5 class="text-purple-400 font-bold text-sm mb-3 flex items-center gap-2">
                                    <i class="fa-regular fa-lightbulb"></i> 추천 아이디어 (선택하세요)
                                </h5>
                                <div id="ideasList" class="flex flex-col gap-2 lg:max-h-[300px] lg:overflow-y-auto lg:custom-scrollbar lg:pr-2">
                                    <!-- Ideas injected here -->
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column: Storyline Result -->
                    <div class="w-full lg:w-7/12 bg-black/20 rounded-xl border border-white/5 p-6 relative min-h-[500px]">
                        
                        <!-- Placeholder -->
                        <div id="storyPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 p-6 text-center">
                            <i class="fa-solid fa-book-open text-4xl mb-3 opacity-50"></i>
                            <p>왼쪽에서 아이디어를 선택하면<br>간단한 스토리라인을 보여줍니다.</p>
                        </div>

                        <!-- Story Loading -->
                        <div id="storyLoader" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-[#1e293b]/90 z-10">
                            <div class="w-12 h-12 border-4 border-green-500/30 border-t-green-500 rounded-full animate-spin mb-4"></div>
                            <p class="text-green-400 font-medium animate-pulse">스토리라인 구성 중...</p>
                        </div>

                        <!-- Story Content -->
                        <div id="storyContent" class="hidden h-full overflow-y-auto custom-scrollbar prose prose-invert max-w-none">
                            <!-- Markdown content injected here -->
                        </div>

                    </div>

                    </div><!-- End of flex container -->
                </div><!-- End of modal body -->
            </div><!-- End of modal content -->
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeSettings()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-[#1e293b] w-full max-w-md rounded-2xl shadow-2xl border border-white/10 pointer-events-auto overflow-hidden transform transition-all scale-95 opacity-0" id="settingsContent">
                
                <!-- Modal Header -->
                <div class="p-6 border-b border-white/10 flex justify-between items-center bg-[#0f172a]">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-gear text-blue-400"></i>
                        <h2 class="text-xl font-bold text-white">API 키 설정</h2>
                    </div>
                    <button onclick="closeSettings()" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="p-6 space-y-6">
                    <p class="text-sm text-gray-400">
                        API 키를 입력하면 브라우저에 안전하게 저장됩니다.
                    </p>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">YouTube Data API Key</label>
                        <input type="password" id="inputYoutubeKey" class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors" placeholder="AIzaSy...">
                        <p class="text-xs text-gray-500 mt-1">
                            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-blue-400 hover:underline">Google Cloud Console</a>에서 발급
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key</label>
                        <input type="password" id="inputGeminiKey" class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors" placeholder="AIzaSy...">
                        <p class="text-xs text-gray-500 mt-1">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 hover:underline">Google AI Studio</a>에서 발급
                        </p>
                    </div>

                    <button onclick="saveApiKeys()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold transition-all shadow-lg shadow-blue-600/20">
                        <i class="fa-solid fa-save mr-2"></i>저장하기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        let YOUTUBE_API_KEY = localStorage.getItem('YOUTUBE_API_KEY') || '';
        let GEMINI_API_KEY = localStorage.getItem('GEMINI_API_KEY') || '';

        // State
        let currentVideos = [];
        let currentVideoData = null;
        let favoriteChannels = JSON.parse(localStorage.getItem('favoriteChannels')) || [];
        let recentSearches = JSON.parse(localStorage.getItem('recentSearches')) || [];

        // ==========================================
        // UTILITIES
        // ==========================================
        
        const formatKoreanNumber = (num) => {
            if (num >= 100000000) return (num / 100000000).toFixed(1) + '억';
            if (num >= 10000) return (num / 10000).toFixed(1) + '만';
            if (num >= 1000) return (num / 1000).toFixed(1) + '천';
            return num.toString();
        };

        const timeAgo = (dateString) => {
            const now = new Date();
            const posted = new Date(dateString);
            const diff = now - posted;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 60) return `${minutes}분 전`;
            if (hours < 24) return `${hours}시간 전`;
            if (days < 30) return `${days}일 전`;
            if (days < 365) return `${Math.floor(days / 30)}개월 전`;
            return `${Math.floor(days / 365)}년 전`;
        };

        const parseDuration = (duration) => {
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            const hours = (parseInt(match[1]) || 0);
            const minutes = (parseInt(match[2]) || 0);
            const seconds = (parseInt(match[3]) || 0);
            return hours * 3600 + minutes * 60 + seconds;
        };

        const formatDuration = (seconds) => {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            } else {
                return `${minutes}:${String(secs).padStart(2, '0')}`;
            }
        };

        const parseNumber = (str) => {
            if (!str) return 0;
            if (typeof str === 'number') return str;
            return parseInt(str.toString().replace(/,/g, '')) || 0;
        };

        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            let icon = 'fa-info-circle';
            let color = 'text-blue-400';
            
            if (type === 'error') {
                icon = 'fa-circle-exclamation';
                color = 'text-red-400';
                toast.style.borderLeftColor = '#ef4444';
            } else if (type === 'success') {
                icon = 'fa-check-circle';
                color = 'text-green-400';
                toast.style.borderLeftColor = '#22c55e';
            }

            toast.innerHTML = `
                <i class="fa-solid ${icon} ${color} text-xl"></i>
                <span class="font-medium">${message}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-in reverse forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        const handleEnter = (e) => {
            if (e.key === 'Enter') searchVideos();
        };

        const updateRatioLabel = (val) => {
            const ratio = val * 10;
            const label = document.getElementById('ratioValueLabel');
            
            let text = '';
            let colorClass = 'text-blue-400';

            if (ratio < 100) {
                text = '일반';
                colorClass = 'text-gray-300';
            } else if (ratio < 300) {
                text = '우수';
                colorClass = 'text-green-400';
            } else if (ratio < 500) {
                text = '대박';
                colorClass = 'text-blue-400';
            } else {
                text = '초대박';
                colorClass = 'text-purple-400';
            }

            label.className = `font-bold transition-all ${colorClass}`;
            label.innerText = `${text} (${ratio}% 이상)`;
        };

        // ==========================================
        // FILTER PERSISTENCE
        // ==========================================
        function saveFilters() {
            localStorage.setItem('filter_duration', document.getElementById('durationFilter').value);
            localStorage.setItem('filter_date', document.getElementById('dateFilter').value);
            localStorage.setItem('filter_ratio', document.getElementById('ratioSlider').value);
            localStorage.setItem('filter_viewCount', document.getElementById('viewCountFilter').value);
        }

        function loadFilters() {
            const duration = localStorage.getItem('filter_duration');
            const date = localStorage.getItem('filter_date');
            const ratio = localStorage.getItem('filter_ratio');
            const viewCount = localStorage.getItem('filter_viewCount');

            if (duration) document.getElementById('durationFilter').value = duration;
            if (date) document.getElementById('dateFilter').value = date;
            if (ratio) {
                document.getElementById('ratioSlider').value = ratio;
                updateRatioLabel(ratio);
            }
            if (viewCount) document.getElementById('viewCountFilter').value = viewCount;
        }

        function saveSortAndApply() {
            sortVideos();
            renderVideos();
        }

        function sortVideos() {
            const sortOrder = document.getElementById('sortFilter')?.value || 'ratio';
            
            switch(sortOrder) {
                case 'views':
                    currentVideos.sort((a, b) => b.viewCount - a.viewCount);
                    break;
                case 'recent':
                    currentVideos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                    break;
                case 'subs':
                    currentVideos.sort((a, b) => b.subCount - a.subCount);
                    break;
                case 'ratio':
                default:
                    currentVideos.sort((a, b) => b.ratio - a.ratio);
                    break;
            }
        }

        // Initialize Filters & Keys & Recent Searches
        window.addEventListener('DOMContentLoaded', () => {
            loadFilters();
            checkApiKeys();
            renderRecentSearches();
        });

        // ==========================================
        // SETTINGS LOGIC
        // ==========================================
        function checkApiKeys() {
            if (!YOUTUBE_API_KEY || !GEMINI_API_KEY) {
                openSettings();
            }
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsContent');
            
            document.getElementById('inputYoutubeKey').value = YOUTUBE_API_KEY;
            document.getElementById('inputGeminiKey').value = GEMINI_API_KEY;

            document.body.style.overflow = 'hidden';
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsContent');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        function saveApiKeys() {
            const yKey = document.getElementById('inputYoutubeKey').value.trim();
            const gKey = document.getElementById('inputGeminiKey').value.trim();

            if (!yKey || !gKey) {
                showToast('모든 API 키를 입력해주세요.', 'error');
                return;
            }

            YOUTUBE_API_KEY = yKey;
            GEMINI_API_KEY = gKey;

            localStorage.setItem('YOUTUBE_API_KEY', YOUTUBE_API_KEY);
            localStorage.setItem('GEMINI_API_KEY', GEMINI_API_KEY);

            showToast('API 키가 저장되었습니다.', 'success');
            closeSettings();
        }

        // ==========================================
        // TAB NAVIGATION & RESET
        // ==========================================
        function resetToHome() {
            showSearchTab();
            document.getElementById('searchInput').value = '';
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('keywordRecommendations').classList.add('hidden');
            document.getElementById('videoGrid').innerHTML = '';
        }

        function updateTabStyles(activeId) {
            const tabs = ['tabSearch', 'tabFavorites', 'tabTrending'];
            tabs.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                
                if (id === activeId) {
                    el.classList.add('bg-white/10', 'text-white', 'shadow-sm');
                    el.classList.remove('text-gray-400');
                } else {
                    el.classList.remove('bg-white/10', 'text-white', 'shadow-sm');
                    el.classList.add('text-gray-400');
                }
            });
        }

        function showSearchTab() {
            document.getElementById('searchTabContent').classList.remove('hidden');
            document.getElementById('favoritesTabContent').classList.add('hidden');
            document.getElementById('trendingTabContent').classList.add('hidden');
            updateTabStyles('tabSearch');
        }

        function showFavoritesTab() {
            document.getElementById('searchTabContent').classList.add('hidden');
            document.getElementById('favoritesTabContent').classList.remove('hidden');
            document.getElementById('trendingTabContent').classList.add('hidden');
            updateTabStyles('tabFavorites');
            loadFavoritesFeed(true);
        }

        function showTrendingTab() {
            document.getElementById('searchTabContent').classList.add('hidden');
            document.getElementById('favoritesTabContent').classList.add('hidden');
            document.getElementById('trendingTabContent').classList.remove('hidden');
            updateTabStyles('tabTrending');
            loadTrendingFeed();
        }

        // ==========================================
        // FAVORITES LOGIC
        // ==========================================
        function toggleFavorite(event, channelId, channelTitle) {
            event.stopPropagation();
            
            const index = favoriteChannels.findIndex(c => c.id === channelId);
            const isAdding = index === -1;

            if (isAdding) {
                // Add
                favoriteChannels.push({ id: channelId, title: channelTitle });
                showToast('즐겨찾기에 추가되었습니다.', 'success');
            } else {
                // Remove
                favoriteChannels.splice(index, 1);
                showToast('즐겨찾기에서 삭제되었습니다.');
            }
            
            localStorage.setItem('favoriteChannels', JSON.stringify(favoriteChannels));
            
            // Update UI if in search results
            const btn = document.getElementById(`fav-btn-${channelId}`);
            if (btn) {
                updateFavoriteBtn(btn, isAdding);
            }

            // Update UI if in favorites tab
            const favoritesTab = document.getElementById('favoritesTabContent');
            if (!favoritesTab.classList.contains('hidden')) {
                if (isAdding) {
                    // If adding while in favorites tab (unlikely but possible via console or other means), reload
                    loadFavoritesFeed();
                } else {
                    // If removing, remove elements directly to save API calls
                    const chip = document.getElementById(`fav-chip-${channelId}`);
                    if (chip) chip.remove();

                    const cards = document.querySelectorAll(`.feed-card[data-channel-id="${channelId}"]`);
                    cards.forEach(card => card.remove());

                    if (favoriteChannels.length === 0) {
                        document.getElementById('emptyFeedMessage').classList.remove('hidden');
                    }
                }
            }
        }

        function updateFavoriteBtn(btn, isFav) {
            if (isFav) {
                btn.innerHTML = '<i class="fa-solid fa-heart text-red-500"></i>';
            } else {
                btn.innerHTML = '<i class="fa-regular fa-heart text-gray-400 hover:text-red-400"></i>';
            }
        }

        function isFavorite(channelId) {
            return favoriteChannels.some(c => c.id === channelId);
        }


        let selectedFeedChannels = JSON.parse(localStorage.getItem('selectedFeedChannels')) || [];

        function toggleFeedChannel(channelId) {
            const index = selectedFeedChannels.indexOf(channelId);
            if (index === -1) {
                selectedFeedChannels.push(channelId);
            } else {
                selectedFeedChannels.splice(index, 1);
            }
            localStorage.setItem('selectedFeedChannels', JSON.stringify(selectedFeedChannels));
            loadFavoritesFeed(); // Reload feed
        }

        async function loadFavoritesFeed() {
            const listContainer = document.getElementById('favoritesList');
            const feedGrid = document.getElementById('feedGrid');
            const emptyMsg = document.getElementById('emptyFeedMessage');
            const loader = document.getElementById('feedLoader');

            // Render Favorites List Chips
            listContainer.innerHTML = '';
            if (favoriteChannels.length === 0) {
                emptyMsg.classList.remove('hidden');
                feedGrid.innerHTML = '';
                return;
            } else {
                emptyMsg.classList.add('hidden');
            }

            // Initialize selected channels if empty
            if (selectedFeedChannels.length === 0 && favoriteChannels.length > 0) {
                selectedFeedChannels = favoriteChannels.map(c => c.id);
                localStorage.setItem('selectedFeedChannels', JSON.stringify(selectedFeedChannels));
            }

            favoriteChannels.forEach(ch => {
                const isSelected = selectedFeedChannels.includes(ch.id);
                const chip = document.createElement('div');
                chip.id = `fav-chip-${ch.id}`;
                chip.className = `flex items-center gap-2 px-3 py-1.5 rounded-full whitespace-nowrap animate-fade-in cursor-pointer transition-all ${
                    isSelected 
                        ? 'bg-purple-600/30 border-2 border-purple-500 text-white' 
                        : 'bg-white/5 border border-white/10 text-gray-400 hover:bg-white/10'
                }`;
                chip.onclick = () => toggleFeedChannel(ch.id);
                chip.innerHTML = `
                    <i class="fa-solid ${isSelected ? 'fa-check-circle text-purple-400' : 'fa-circle text-gray-600'}"></i>
                    <span class="text-sm font-medium">${ch.title}</span>
                    <button onclick="event.stopPropagation(); toggleFavorite(event, '${ch.id}', '${ch.title}')" class="text-gray-500 hover:text-red-400 ml-1">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
                listContainer.appendChild(chip);
            });

            // Load Videos (API call)
            feedGrid.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                // Filter to only selected channels
                const activeChannels = favoriteChannels.filter(c => selectedFeedChannels.includes(c.id));
                
                if (activeChannels.length === 0) {
                    loader.classList.add('hidden');
                    feedGrid.innerHTML = '<div class="col-span-full text-center py-20 text-gray-500"><i class="fa-regular fa-square-check text-4xl mb-4 opacity-50"></i><p>채널을 선택하여 영상을 확인하세요.</p></div>';
                    return;
                }

                // 1. Get Uploads Playlist IDs for selected favorite channels
                const channelIds = activeChannels.map(c => c.id).join(',');
                const channelsUrl = `https://www.googleapis.com/youtube/v3/channels?part=contentDetails,snippet,statistics&id=${channelIds}&key=${YOUTUBE_API_KEY}`;
                const channelsRes = await fetch(channelsUrl);
                const channelsData = await channelsRes.json();

                if (!channelsData.items) throw new Error('채널 정보를 가져올 수 없습니다.');

                const channelMap = {};
                channelsData.items.forEach(ch => {
                    channelMap[ch.id] = ch.statistics;
                });

                // 2. Fetch latest 5 videos from each channel's uploads playlist
                const videoPromises = channelsData.items.map(async (channel) => {
                    const uploadsId = channel.contentDetails.relatedPlaylists.uploads;
                    const playlistUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${uploadsId}&maxResults=5&key=${YOUTUBE_API_KEY}`;
                    const plRes = await fetch(playlistUrl);
                    const plData = await plRes.json();
                    
                    return plData.items ? plData.items.map(item => ({
                        id: item.snippet.resourceId.videoId,
                        title: item.snippet.title,
                        thumbnail: item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                        channelTitle: item.snippet.channelTitle,
                        channelId: item.snippet.channelId,
                        publishedAt: item.snippet.publishedAt,
                        isFeed: true // Marker
                    })) : [];
                });

                const results = await Promise.all(videoPromises);
                let allVideos = results.flat();

                // Sort by Date Descending
                allVideos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));

                // Limit to maximum 20 videos total
                allVideos = allVideos.slice(0, 20);

                // Render Feed
                loader.classList.add('hidden');
                
                // We need to fetch view counts for these videos to show stats properly
                // But to save quota, we might skip it or do a bulk fetch. Let's do a bulk fetch.
                const videoIds = allVideos.map(v => v.id).join(',');
                if (videoIds) {
                    const statsUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
                    const statsRes = await fetch(statsUrl);
                    const statsData = await statsRes.json();
                    
                    const statsMap = {};
                    const durationMap = {};
                    if(statsData.items) {
                        statsData.items.forEach(item => {
                            statsMap[item.id] = item.statistics;
                            durationMap[item.id] = item.contentDetails.duration;
                        });
                    }

                    // Merge stats
                    allVideos = allVideos.map(v => {
                        const viewCount = parseNumber(statsMap[v.id]?.viewCount);
                        const chStats = channelMap[v.channelId];
                        const subCount = parseNumber(chStats?.subscriberCount);
                        const hiddenSubs = chStats?.hiddenSubscriberCount || false;
                        
                        let ratio = 0;
                        if (subCount > 0) {
                            ratio = (viewCount / subCount) * 100;
                        }

                        return {
                            ...v,
                            viewCount,
                            subCount,
                            hiddenSubs,
                            ratio,
                            durationSec: parseDuration(durationMap[v.id] || 'PT0S')
                        };
                    });
                }

                // Filter by selected channels
                const filteredVideos = selectedFeedChannels.length > 0 
                    ? allVideos.filter(v => selectedFeedChannels.includes(v.channelId))
                    : allVideos;

                // Render videos
                loader.classList.add('hidden');
                feedGrid.innerHTML = '';
                
                if (filteredVideos.length === 0) {
                    feedGrid.innerHTML = '<div class="col-span-full text-center py-20 text-gray-500"><i class="fa-regular fa-square-check text-4xl mb-4 opacity-50"></i><p>채널을 선택하여 영상을 확인하세요.</p></div>';
                    return;
                }

                filteredVideos.forEach((video, index) => {
                    const isHighPerformer = video.ratio >= 300;
                    const ratioDisplay = video.hiddenSubs ? 'N/A' : `${video.ratio.toFixed(0)}%`;
                    const ratioColor = isHighPerformer ? 'text-red-400' : 'text-green-400';
                    const cardBorder = isHighPerformer ? 'border-red-500/30' : 'border-white/5';
                    const glow = isHighPerformer ? 'shadow-[0_0_15px_rgba(239,68,68,0.15)]' : '';
                    const timeAgoStr = timeAgo(video.publishedAt);

                    const card = document.createElement('div');
                    card.className = `glass-card rounded-xl overflow-hidden flex flex-col h-full ${cardBorder} ${glow} feed-card animate-fade-in`;
                    card.style.animationDelay = `${index * 50}ms`;
                    card.setAttribute('data-channel-id', video.channelId);
                    card.innerHTML = `
                        <div class="relative group cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">
                            <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-48 object-cover transition-transform duration-500 group-hover:scale-105">
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <i class="fa-brands fa-youtube text-red-500 text-4xl drop-shadow-lg"></i>
                            </div>
                            ${isHighPerformer ? '<div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow-lg flex items-center gap-1"><i class="fa-solid fa-fire"></i> HOT</div>' : ''}
                            <div class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded">
                                ${timeAgoStr}
                            </div>
                        </div>
                        
                        <div class="p-5 flex flex-col flex-grow">
                            <h3 class="text-lg font-bold text-white mb-2 line-clamp-2 leading-snug" title="${video.title}">${video.title}</h3>
                            <p class="text-gray-400 text-sm mb-4 flex items-center gap-1">
                                <i class="fa-solid fa-user-circle"></i> ${video.channelTitle}
                            </p>
                            
                            <div class="grid grid-cols-3 gap-2 mb-6 bg-black/20 rounded-lg p-3 border border-white/5">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500 mb-1">조회수</div>
                                    <div class="font-semibold text-white text-sm">${formatKoreanNumber(video.viewCount)}회</div>
                                </div>
                                <div class="text-center border-l border-white/10">
                                    <div class="text-xs text-gray-500 mb-1">구독자</div>
                                    <div class="font-semibold text-white text-sm">${video.hiddenSubs || video.subCount === 0 ? '비공개' : formatKoreanNumber(video.subCount) + '명'}</div>
                                </div>
                                <div class="text-center border-l border-white/10">
                                    <div class="text-xs text-gray-500 mb-1">성과율</div>
                                    <div class="font-bold ${ratioColor} text-sm">${ratioDisplay}</div>
                                </div>
                            </div>

                            <button onclick="openAnalysisFromFeed('${video.id}', '${video.title.replace(/'/g, "\\'")}', '${video.thumbnail}', '${video.channelTitle}', ${video.ratio}, ${video.hiddenSubs})" class="mt-auto w-full bg-white/5 hover:bg-blue-600 hover:text-white text-gray-300 border border-white/10 hover:border-blue-500 py-2.5 rounded-lg transition-all duration-200 font-medium flex items-center justify-center gap-2 group">
                                <i class="fa-solid fa-wand-magic-sparkles group-hover:animate-pulse"></i> AI 분석하기
                            </button>
                        </div>
                    `;
                    feedGrid.appendChild(card);
                });

            } catch (error) {
                console.error('Feed loading error:', error);
                loader.classList.add('hidden');
                
                // Check if it's an API error
                if (error.message && error.message.includes('채널 정보')) {
                    showToast('YouTube API 오류: API 키를 확인하거나 할당량을 확인해주세요.', 'error');
                    feedGrid.innerHTML = `
                        <div class="col-span-full text-center py-20">
                            <i class="fa-solid fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-gray-400 mb-2">YouTube API 오류가 발생했습니다.</p>
                            <p class="text-sm text-gray-500">API 키가 올바른지 확인하거나, 일일 할당량이 초과되지 않았는지 확인해주세요.</p>
                            <button onclick="openSettings()" class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors">
                                API 키 설정
                            </button>
                        </div>
                    `;
                } else {
                    showToast('피드를 불러오는 중 오류가 발생했습니다.', 'error');
                }
            }
        }

        // Helper for Feed Analysis (since feed items aren't in currentVideos)
        function openAnalysisFromFeed(id, title, thumbnail, channelTitle, ratio, hiddenSubs) {
            currentVideoData = { id, title, thumbnail, channelTitle, hiddenSubs, ratio }; 
            
            // Set Modal Info
            document.getElementById('modalThumbnail').src = thumbnail;
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalChannel').innerText = channelTitle;
            document.getElementById('modalRatio').innerText = hiddenSubs ? 'N/A' : `성과율 ${ratio.toFixed(0)}%`;

            // Reset UI States
            document.getElementById('aiLoader').classList.remove('hidden');
            document.getElementById('analysisResult').classList.add('hidden');
            document.getElementById('storyPlaceholder').classList.remove('hidden');
            document.getElementById('storyContent').classList.add('hidden');
            document.getElementById('storyContent').innerHTML = '';
            
            // Show Modal
            const modal = document.getElementById('analysisModal');
            const content = document.getElementById('modalContent');
            
            document.body.style.overflow = 'hidden';
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);

            analyzeVideo(currentVideoData);
        }

        // ==========================================
        // YOUTUBE API LOGIC (SEARCH)
        // ==========================================
        async function searchVideos() {
            const query = document.getElementById('searchInput').value.trim();
            const durationFilter = document.getElementById('durationFilter').value;
            const minRatio = parseInt(document.getElementById('ratioSlider').value) * 10;
            const minViewCount = parseInt(document.getElementById('viewCountFilter').value);
            const dateFilter = document.getElementById('dateFilter').value;

            if (!query) {
                showToast('검색어를 입력해주세요.', 'error');
                return;
            }

            // UI Reset
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('searchLoader').classList.remove('hidden');
            document.getElementById('videoGrid').innerHTML = '';
            document.getElementById('keywordRecommendations').classList.add('hidden');

            // Fetch Related Keywords (Parallel)
            fetchRelatedKeywords(query);
            
            // Save Recent Search
            saveRecentSearch(query);

            try {
                // 1. Search Videos Only (no channels)
                let searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&q=${encodeURIComponent(query)}&regionCode=KR&relevanceLanguage=ko&key=${YOUTUBE_API_KEY}`;
                
                // Apply API filters where possible
                if (durationFilter !== 'any') {
                    if (durationFilter === 'short') searchUrl += `&videoDuration=short`;
                    else if (durationFilter === 'medium') searchUrl += `&videoDuration=medium`;
                    else if (durationFilter === 'long') searchUrl += `&videoDuration=long`;
                }

                if (dateFilter !== 'any') {
                    const now = new Date();
                    let daysToSubtract = 0;
                    
                    if (dateFilter === '1d') daysToSubtract = 1;
                    else if (dateFilter === '7d') daysToSubtract = 7;
                    else if (dateFilter === '15d') daysToSubtract = 15;
                    else if (dateFilter === '30d') daysToSubtract = 30;
                    else if (dateFilter === '90d') daysToSubtract = 90;

                    if (daysToSubtract > 0) {
                        const pastDate = new Date(now.setDate(now.getDate() - daysToSubtract));
                        searchUrl += `&publishedAfter=${pastDate.toISOString()}`;
                    }
                }

                const searchRes = await fetch(searchUrl);
                const searchData = await searchRes.json();

                if (!searchData.items || searchData.items.length === 0) {
                    throw new Error('검색 결과가 없습니다.');
                }

                const videoIds = searchData.items.map(item => item.id.videoId).join(',');
                const channelIds = [...new Set(searchData.items.map(item => item.snippet.channelId))].join(',');

                // 2. Get Video Stats
                const videosUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
                const videosRes = await fetch(videosUrl);
                const videosData = await videosRes.json();

                // 3. Get Channel Stats
                const channelsUrl = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelIds}&key=${YOUTUBE_API_KEY}`;
                const channelsRes = await fetch(channelsUrl);
                const channelsData = await channelsRes.json();

                // 4. Merge Data
                const statsMap = {};
                const durationMap = {};
                videosData.items.forEach(item => {
                    statsMap[item.id] = item.statistics;
                    durationMap[item.id] = item.contentDetails.duration;
                });

                const channelMap = {};
                channelsData.items.forEach(item => {
                    channelMap[item.id] = item.statistics;
                });

                const processedVideos = searchData.items.map(item => {
                    const vidId = item.id.videoId;
                    const chId = item.snippet.channelId;
                    const viewCount = parseNumber(statsMap[vidId]?.viewCount);
                    const subCount = parseNumber(channelMap[chId]?.subscriberCount);
                    const hiddenSubs = channelMap[chId]?.hiddenSubscriberCount || false;
                    const durationStr = durationMap[vidId] || 'PT0S';
                    const durationSec = parseDuration(durationStr);

                    let ratio = 0;
                    if (subCount > 0) {
                        ratio = (viewCount / subCount) * 100;
                    }

                    return {
                        type: 'video',
                        id: vidId,
                        title: item.snippet.title,
                        thumbnail: item.snippet.thumbnails.medium.url,
                        channelTitle: item.snippet.channelTitle,
                        channelId: chId,
                        publishedAt: item.snippet.publishedAt,
                        viewCount,
                        subCount,
                        hiddenSubs,
                        ratio,
                        durationSec
                    };
                });

                // Client-side Filtering for Videos
                currentVideos = processedVideos.filter(v => {
                    if (v.ratio < minRatio) return false;
                    if (v.viewCount < minViewCount) return false;
                    if (durationFilter === 'short') return v.durationSec < 180;
                    if (durationFilter === 'medium') return v.durationSec >= 180 && v.durationSec < 1200;
                    if (durationFilter === 'long') return v.durationSec >= 1200;
                    return true;
                });

                // Sort Videos
                sortVideos();

                renderVideos();
                document.getElementById('resultCount').innerText = currentVideos.length;
                document.getElementById('searchLoader').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');

                if (currentVideos.length === 0) {
                    showToast('조건에 맞는 결과가 없습니다.', 'error');
                }

            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('searchLoader').classList.add('hidden');
                
                let errorMessage = 'API 호출 중 오류가 발생했습니다.';
                if (error.message) {
                    if (error.message.includes('quota') || error.message.includes('403')) {
                        errorMessage = 'YouTube API 할당량이 초과되었습니다. 내일 다시 시도하거나 API 키를 확인해주세요.';
                    } else if (error.message.includes('401') || error.message.includes('key')) {
                        errorMessage = 'API 키가 유효하지 않습니다. 설정에서 API 키를 확인해주세요.';
                    } else {
                        errorMessage = error.message;
                    }
                }
                showToast(errorMessage, 'error');
            }
        }

        function renderVideos() {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '';

            currentVideos.forEach((video, index) => {
                const isHighPerformer = video.ratio >= 300;
                const ratioDisplay = video.hiddenSubs ? 'N/A' : `${video.ratio.toFixed(0)}%`;
                const ratioColor = isHighPerformer ? 'text-red-400' : 'text-green-400';
                const cardBorder = isHighPerformer ? 'border-red-500/30' : 'border-white/5';
                const glow = isHighPerformer ? 'shadow-[0_0_15px_rgba(239,68,68,0.15)]' : '';
                const timeAgoStr = timeAgo(video.publishedAt);
                const isFav = isFavorite(video.channelId);

                const card = document.createElement('div');
                card.className = `glass-card rounded-xl overflow-hidden flex flex-col h-full ${cardBorder} ${glow}`;
                card.style.animationDelay = `${index * 100}ms`;
                card.classList.add('animate-slide-up');
                card.innerHTML = `
                    <div class="relative group cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">
                            <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-48 object-cover transition-transform duration-500 group-hover:scale-105">
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <i class="fa-brands fa-youtube text-red-500 text-4xl drop-shadow-lg"></i>
                            </div>
                            ${isHighPerformer ? '<div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow-lg flex items-center gap-1"><i class="fa-solid fa-fire"></i> HOT</div>' : ''}
                            <div class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded">
                                ${timeAgoStr}
                            </div>
                        </div>
                        
                        <div class="p-5 flex flex-col flex-grow">
                            <h3 class="text-lg font-bold text-white mb-2 line-clamp-2 leading-snug" title="${video.title}">${video.title}</h3>
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-gray-400 text-sm flex items-center gap-1">
                                    <i class="fa-solid fa-user-circle"></i> ${video.channelTitle}
                                </p>
                                <button id="fav-btn-${video.channelId}" onclick="toggleFavorite(event, '${video.channelId}', '${video.channelTitle}')" class="text-lg transition-transform hover:scale-110">
                                    ${isFav ? '<i class="fa-solid fa-heart text-red-500"></i>' : '<i class="fa-regular fa-heart text-gray-400 hover:text-red-400"></i>'}
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 mb-6 bg-black/20 rounded-lg p-3 border border-white/5">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500 mb-1">조회수</div>
                                    <div class="font-semibold text-white text-sm">${formatKoreanNumber(video.viewCount)}회</div>
                                </div>
                                <div class="text-center border-l border-white/10">
                                    <div class="text-xs text-gray-500 mb-1">구독자</div>
                                    <div class="font-semibold text-white text-sm">${video.hiddenSubs || video.subCount === 0 ? '비공개' : formatKoreanNumber(video.subCount) + '명'}</div>
                                </div>
                                <div class="text-center border-l border-white/10">
                                    <div class="text-xs text-gray-500 mb-1">성과율</div>
                                    <div class="font-bold ${ratioColor} text-sm">${ratioDisplay}</div>
                                </div>
                            </div>

                            <button onclick="openAnalysis('${video.id}')" class="mt-auto w-full bg-white/5 hover:bg-blue-600 hover:text-white text-gray-300 border border-white/10 hover:border-blue-500 py-2.5 rounded-lg transition-all duration-200 font-medium flex items-center justify-center gap-2 group">
                                <i class="fa-solid fa-wand-magic-sparkles group-hover:animate-pulse"></i> AI 분석하기
                            </button>
                        </div>
                    `;
                grid.appendChild(card);
            });
        }

        // ==========================================
        // ANALYSIS & GEMINI LOGIC
        // ==========================================
        
        function openAnalysis(videoId) {
            currentVideoData = currentVideos.find(v => v.id === videoId);
            
            // Set Modal Info
            document.getElementById('modalThumbnail').src = currentVideoData.thumbnail;
            document.getElementById('modalTitle').innerText = currentVideoData.title;
            document.getElementById('modalChannel').innerText = currentVideoData.channelTitle;
            document.getElementById('modalRatio').innerText = currentVideoData.hiddenSubs ? 'N/A' : `성과율 ${currentVideoData.ratio.toFixed(0)}%`;

            // Reset UI States
            document.getElementById('aiLoader').classList.remove('hidden');
            document.getElementById('analysisResult').classList.add('hidden');
            document.getElementById('storyPlaceholder').classList.remove('hidden');
            document.getElementById('storyContent').classList.add('hidden');
            document.getElementById('storyContent').innerHTML = '';
            
            // Show Modal
            const modal = document.getElementById('analysisModal');
            const content = document.getElementById('modalContent');
            
            document.body.style.overflow = 'hidden';
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);

            // Start Analysis
            analyzeVideo(currentVideoData);
        }

        function closeModal() {
            const modal = document.getElementById('analysisModal');
            const content = document.getElementById('modalContent');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        async function analyzeVideo(video) {
            try {
                // 1. Fetch Comments
                const commentsUrl = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${video.id}&maxResults=30&order=relevance&key=${YOUTUBE_API_KEY}`;
                const commentsRes = await fetch(commentsUrl);
                
                let comments = "댓글 없음";
                if (commentsRes.ok) {
                    const commentsData = await commentsRes.json();
                    if (commentsData.items) {
                        comments = commentsData.items.map(item => item.snippet.topLevelComment.snippet.textDisplay).join("\n");
                    }
                }

                // 2. Call Gemini for Summary & Ideas (Senior Drama Focus)
                const prompt = `
                    너는 시니어 드라마 콘텐츠 기획 전문가야.
                    다음 영상의 제목과 댓글을 분석해서 3가지 정보를 JSON으로 줘.
                    
                    [영상 제목]: ${video.title}
                    [댓글]: ${comments.substring(0, 3000)}

                    요구사항:
                    1. summary: 이 영상이 어떤 내용인지 제목과 댓글로 유추해서 2문장 요약.
                    2. reactions: 시청자들이 주로 어떤 반응(재미, 유익, 공감 등)을 보였는지 2문장 요약.
                    3. ideas: 이 영상의 주제나 감정, 스토리 요소를 활용하여 만들 수 있는 **시니어 드라마 에피소드 아이디어** 10가지.
                       - 시니어(중·장년층, 노년층)가 주인공인 드라마 형식으로 구성
                       - 각 아이디어는 감동, 인생 교훈, 일상의 위로, 가족애, 추억 등 시니어 세대가 공감할 수 있는 주제여야 함
                       - 제목은 드라마 에피소드처럼 간결하고 흥미로운 형식으로 작성 (예: "은퇴 후 시작한 작은 식당", "할머니의 첫 스마트폰")

                    반드시 JSON 형식으로만 답변해. 마크다운 쓰지 마.
                    형식: 
                    { 
                        "summary": "...", 
                        "reactions": "...", 
                        "ideas": ["드라마 아이디어1", "드라마 아이디어2", "드라마 아이디어3", "드라마 아이디어4", "드라마 아이디어5", "드라마 아이디어6", "드라마 아이디어7", "드라마 아이디어8", "드라마 아이디어9", "드라마 아이디어10"] 
                    }
                `;

                const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                const geminiRes = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const geminiData = await geminiRes.json();
                const rawText = geminiData.candidates[0].content.parts[0].text;
                const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const result = JSON.parse(jsonText);

                renderAnalysis(result);

            } catch (error) {
                console.error(error);
                showToast('분석 중 오류가 발생했습니다.', 'error');
                document.getElementById('aiLoader').classList.add('hidden');
            }
        }

        function renderAnalysis(data) {
            // Summary & Reactions
            document.getElementById('aiSummary').innerText = data.summary;
            document.getElementById('aiReactions').innerText = data.reactions;

            // Ideas List
            const list = document.getElementById('ideasList');
            list.innerHTML = '';

            data.ideas.forEach(idea => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left px-4 py-3 rounded-lg bg-white/5 hover:bg-purple-600 hover:text-white border border-white/5 transition-all duration-200 text-sm text-gray-300 flex justify-between items-center group';
                btn.innerHTML = `
                    <span class="font-medium line-clamp-1">${idea}</span>
                    <i class="fa-solid fa-pen-nib opacity-0 group-hover:opacity-100 transition-opacity"></i>
                `;
                btn.onclick = () => generateStoryline(idea);
                list.appendChild(btn);
            });

            document.getElementById('aiLoader').classList.add('hidden');
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('analysisResult').classList.add('animate-fade-in');
        }

        async function generateStoryline(idea) {
            // UI Update
            document.getElementById('storyPlaceholder').classList.add('hidden');
            document.getElementById('storyContent').classList.add('hidden');
            document.getElementById('storyLoader').classList.remove('hidden');

            // Highlight selected idea
            const buttons = document.getElementById('ideasList').querySelectorAll('button');
            buttons.forEach(b => {
                if(b.innerText.includes(idea)) {
                    b.classList.add('bg-purple-600', 'text-white', 'border-purple-500');
                    b.classList.remove('bg-white/5', 'text-gray-300');
                } else {
                    b.classList.remove('bg-purple-600', 'text-white', 'border-purple-500');
                    b.classList.add('bg-white/5', 'text-gray-300');
                }
            });

            try {
                const prompt = `
                    너는 창의적인 스토리텔러야.
                    
                    [선택한 아이디어]: "${idea}"
                    [참고한 원본 영상]: "${currentVideoData.title}"
                    
                    위 아이디어로 영상을 만들 때 사용할 수 있는 **간단하고 매력적인 스토리라인**을 작성해줘.
                    복잡한 대본 형식이 아니라, 이야기의 흐름을 파악할 수 있는 줄거리 형태여야 해.
                    
                    [구성]
                    1. **기획 의도**: 왜 이 소재가 먹힐까? (1줄)
                    2. **도입부 (Hook)**: 시청자를 사로잡을 첫 장면이나 멘트.
                    3. **전개 (Flow)**: 이야기의 핵심 흐름 (3단계).
                    4. **결말 (Climax/Outro)**: 인상 깊은 마무리.
                    
                    출력 형식: 가독성 좋은 마크다운(Markdown).
                `;

                const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                const geminiRes = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const geminiData = await geminiRes.json();
                const storyMarkdown = geminiData.candidates[0].content.parts[0].text;

                // Render Markdown
                const contentDiv = document.getElementById('storyContent');
                contentDiv.innerHTML = marked.parse(storyMarkdown);
                
                document.getElementById('storyLoader').classList.add('hidden');
                contentDiv.classList.remove('hidden');
                contentDiv.classList.add('animate-fade-in');

            } catch (error) {
                console.error(error);
                showToast('스토리 생성 중 오류가 발생했습니다.', 'error');
                document.getElementById('storyLoader').classList.add('hidden');
            }
        }

        // ==========================================
        // KEYWORD RECOMMENDATION LOGIC
        // ==========================================
        async function fetchRelatedKeywords(query) {
            try {
                const prompt = `
                    너는 유튜브 검색 전문가야.
                    사용자가 "${query}"라는 키워드로 검색했어.
                    이와 연관성이 높고, 유튜브에서 검색량이 많을 것으로 예상되는 '추천 검색어' 6가지를 추천해줘.
                    
                    조건:
                    1. 한국어 키워드 위주로.
                    2. 너무 긴 문장보다는 검색에 실제로 쓰이는 단어 조합으로.
                    3. JSON 배열 형식으로만 출력해. (예: ["키워드1", "키워드2", ...])
                `;

                const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                const res = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                const jsonText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const keywords = JSON.parse(jsonText);

                renderRelatedKeywords(keywords);

            } catch (error) {
                console.error("Keyword fetch failed:", error);
                // Fail silently for keywords, main search is more important
            }
        }

        function renderRelatedKeywords(keywords) {
            const container = document.getElementById('keywordRecommendations');
            const list = document.getElementById('keywordList');
            
            list.innerHTML = '';
            
            if (!keywords || keywords.length === 0) return;

            keywords.forEach(k => {
                const chip = document.createElement('button');
                chip.className = 'px-3 py-1 rounded-full bg-white/5 hover:bg-blue-600/20 hover:text-blue-300 border border-white/10 hover:border-blue-500/30 text-gray-400 text-xs transition-all duration-200';
                chip.innerText = k;
                chip.onclick = () => handleKeywordClick(k);
                list.appendChild(chip);
            });

            container.classList.remove('hidden');
        }

        function handleKeywordClick(keyword) {
            document.getElementById('searchInput').value = keyword;
            searchVideos();
        }

        // ==========================================
        // RECENT SEARCH LOGIC
        // ==========================================
        function saveRecentSearch(keyword) {
            // Remove if exists (to move to top)
            recentSearches = recentSearches.filter(k => k !== keyword);
            
            // Add to top
            recentSearches.unshift(keyword);
            
            // Limit to 10
            if (recentSearches.length > 10) {
                recentSearches = recentSearches.slice(0, 10);
            }
            
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            renderRecentSearches();
        }

        function renderRecentSearches() {
            const container = document.getElementById('recentSearchSection');
            const list = document.getElementById('recentSearchList');
            
            list.innerHTML = '';
            
            if (recentSearches.length === 0) {
                container.classList.add('hidden');
                return;
            }

            recentSearches.forEach(k => {
                const chip = document.createElement('div');
                chip.className = 'flex items-center gap-2 bg-white/5 hover:bg-white/10 border border-white/10 px-2 py-1 rounded text-xs text-gray-300 transition-colors cursor-pointer group';
                chip.innerHTML = `
                    <span onclick="handleKeywordClick('${k}')">${k}</span>
                    <button onclick="deleteRecentSearch(event, '${k}')" class="text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
                list.appendChild(chip);
            });

            container.classList.remove('hidden');
        }

        function deleteRecentSearch(event, keyword) {
            event.stopPropagation();
            recentSearches = recentSearches.filter(k => k !== keyword);
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            renderRecentSearches();
        }

        function clearRecentSearches() {
            if(confirm('최근 검색 기록을 모두 삭제하시겠습니까?')) {
                recentSearches = [];
                localStorage.removeItem('recentSearches');
                renderRecentSearches();
            }
        }

        // ==========================================
        // TRENDING LOGIC
        // ==========================================
        
        let trendingKeywords = JSON.parse(localStorage.getItem('trendingKeywords')) || [
            "시니어 드라마", "숏폼 드라마", "중년 공감 쇼츠", "노부부 이야기", 
            "고부갈등", "가족 숏드라마", "주부 공감 시트콤", "인생 2막", "황혼이야기"
        ];
        
        let recommendedTrendingKeywords = [
            "은퇴 후 삶", "건강 정보", "트로트", "추억 여행", "손주 사랑", "귀농 귀촌"
        ];

        let cachedTrendingVideos = JSON.parse(localStorage.getItem('cachedTrendingVideos')) || [];
        let lastTrendingFetchTime = parseInt(localStorage.getItem('lastTrendingFetchTime')) || 0;

        function handleTrendingInputKey(e) {
            if (e.key === 'Enter') addCustomTrendingKeyword();
        }

        function addCustomTrendingKeyword() {
            const input = document.getElementById('trendingKeywordInput');
            const keyword = input.value.trim();
            
            if (keyword) {
                addTrendingKeyword(keyword);
                input.value = '';
            }
        }

        function renderTrendingKeywords() {
            const list = document.getElementById('trendingKeywordsList');
            const recList = document.getElementById('trendingRecommendedList');
            const recContainer = document.getElementById('trendingKeywordRecommendations');
            
            // Active Keywords
            list.innerHTML = '';
            trendingKeywords.forEach(k => {
                const chip = document.createElement('div');
                chip.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full whitespace-nowrap bg-purple-600/30 border border-purple-500 text-white animate-fade-in';
                chip.innerHTML = `
                    <span class="text-sm font-medium">${k}</span>
                    <button onclick="removeTrendingKeyword('${k}')" class="text-gray-400 hover:text-red-400 ml-1">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
                list.appendChild(chip);
            });

            // Recommended Keywords (exclude active ones)
            recList.innerHTML = '';
            const availableRecs = recommendedTrendingKeywords.filter(k => !trendingKeywords.includes(k));
            
            if (availableRecs.length > 0) {
                availableRecs.forEach(k => {
                    const chip = document.createElement('button');
                    chip.className = 'px-3 py-1 rounded-full bg-white/5 hover:bg-blue-600/20 hover:text-blue-300 border border-white/10 hover:border-blue-500/30 text-gray-400 text-xs transition-all duration-200 flex items-center gap-1';
                    chip.innerHTML = `<i class="fa-solid fa-plus text-[10px]"></i> ${k}`;
                    chip.onclick = () => addTrendingKeyword(k);
                    recList.appendChild(chip);
                });
                recContainer.classList.remove('hidden');
            } else {
                recContainer.classList.add('hidden');
            }
        }

        function addTrendingKeyword(keyword) {
            if (!trendingKeywords.includes(keyword)) {
                trendingKeywords.push(keyword);
                localStorage.setItem('trendingKeywords', JSON.stringify(trendingKeywords));
                renderTrendingKeywords();
                loadTrendingFeed(true); // Refresh feed with new keyword
            }
        }

        function removeTrendingKeyword(keyword) {
            trendingKeywords = trendingKeywords.filter(k => k !== keyword);
            localStorage.setItem('trendingKeywords', JSON.stringify(trendingKeywords));
            renderTrendingKeywords();
            loadTrendingFeed(true); // Refresh feed without keyword
        }

        async function loadTrendingFeed(forceRefresh = false) {
            console.log('loadTrendingFeed called. Force:', forceRefresh);
            const grid = document.getElementById('trendingGrid');
            const loader = document.getElementById('trendingLoader');
            const emptyMsg = document.getElementById('emptyTrendingMessage');
            
            renderTrendingKeywords();

            // Check cache (6 hours = 21600000 ms)
            const now = Date.now();
            const cacheDuration = 6 * 60 * 60 * 1000;
            
            if (!forceRefresh && cachedTrendingVideos.length > 0 && (now - lastTrendingFetchTime < cacheDuration)) {
                console.log('Using cached trending videos');
                renderTrendingVideos(cachedTrendingVideos);
                return;
            }

            if (trendingKeywords.length === 0) {
                grid.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }

            emptyMsg.classList.add('hidden');
            grid.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                // 1. Split keywords into chunks (3 keywords per request) to avoid query complexity issues
                const chunkSize = 3;
                const keywordChunks = [];
                for (let i = 0; i < trendingKeywords.length; i += chunkSize) {
                    keywordChunks.push(trendingKeywords.slice(i, i + chunkSize));
                }

                // Extend search period to 3 weeks
                const searchDate = new Date();
                searchDate.setDate(searchDate.getDate() - 21); 
                const publishedAfter = searchDate.toISOString();

                console.log(`Splitting ${trendingKeywords.length} keywords into ${keywordChunks.length} chunks.`);

                // 2. Parallel Fetch for each chunk
                const searchPromises = keywordChunks.map(async (chunk, index) => {
                    const query = chunk.join('|');
                    // Limit maxResults per chunk to keep total reasonable (e.g., 15 per chunk)
                    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&order=viewCount&publishedAfter=${publishedAfter}&maxResults=15&regionCode=KR&key=${YOUTUBE_API_KEY}`;
                    
                    try {
                        const res = await fetch(url);
                        if (!res.ok) {
                            console.warn(`Chunk ${index} failed:`, res.statusText);
                            return { items: [] };
                        }
                        return await res.json();
                    } catch (e) {
                        console.warn(`Chunk ${index} error:`, e);
                        return { items: [] };
                    }
                });

                const results = await Promise.all(searchPromises);
                
                // 3. Merge Results & Remove Duplicates
                let allItems = [];
                results.forEach(r => {
                    if (r.items) allItems = allItems.concat(r.items);
                });

                const uniqueItems = [];
                const seenIds = new Set();
                allItems.forEach(item => {
                    if (item.id && item.id.videoId && !seenIds.has(item.id.videoId)) {
                        seenIds.add(item.id.videoId);
                        uniqueItems.push(item);
                    }
                });

                console.log(`Total unique videos found from all chunks: ${uniqueItems.length}`);
                
                if (uniqueItems.length === 0) {
                    console.log('No items found from any chunk.');
                    cachedTrendingVideos = [];
                    renderTrendingVideos([]);
                    loader.classList.add('hidden');
                    return;
                }

                // 4. Fetch Statistics (Limit to top 50 videos)
                // Since we don't have view counts yet, we just take the first 50 from the search results
                // (Search results are somewhat sorted by viewCount per chunk, but mixing them might lose global order. 
                // However, fetching stats for all is too expensive if list is huge. 50 is safe.)
                const targetItems = uniqueItems.slice(0, 50);
                const videoIds = targetItems.map(item => item.id.videoId).join(',');
                
                const statsResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails,snippet&id=${videoIds}&key=${YOUTUBE_API_KEY}`);
                const statsData = await statsResponse.json();

                // Process videos (Initial filter: 10k+ views)
                let processedVideos = statsData.items.map(item => {
                    const viewCount = parseInt(item.statistics.viewCount) || 0;
                    const durationSec = parseDuration(item.contentDetails.duration);
                    
                    return {
                        id: item.id,
                        title: item.snippet.title,
                        thumbnail: item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                        channelTitle: item.snippet.channelTitle,
                        channelId: item.snippet.channelId,
                        publishedAt: item.snippet.publishedAt,
                        viewCount: viewCount,
                        durationSec: durationSec,
                        subCount: 0, 
                        ratio: 0,
                        hiddenSubs: false
                    };
                }).filter(v => v.viewCount >= 10000); 
                
                console.log('Processed videos count (after view count filter):', processedVideos.length);

                // Fetch Channel Details for Ratio Calculation
                if (processedVideos.length > 0) {
                    const channelIds = [...new Set(processedVideos.map(v => v.channelId))].join(',');
                    const channelResponse = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelIds}&key=${YOUTUBE_API_KEY}`);
                    const channelData = await channelResponse.json();
                    
                    const channelMap = {};
                    channelData.items.forEach(ch => {
                        channelMap[ch.id] = {
                            subCount: parseInt(ch.statistics.subscriberCount) || 0,
                            hiddenSubs: ch.statistics.hiddenSubscriberCount
                        };
                    });

                    processedVideos.forEach(v => {
                        const ch = channelMap[v.channelId];
                        if (ch) {
                            v.subCount = ch.subCount;
                            v.hiddenSubs = ch.hiddenSubs;
                            if (!v.hiddenSubs && v.subCount > 0) {
                                v.ratio = (v.viewCount / v.subCount) * 100;
                            } else {
                                v.ratio = 0;
                            }
                        }
                    });
                }

                // Filter by Ratio >= 300%
                const highRatioVideos = processedVideos.filter(v => v.ratio >= 300);
                console.log('High ratio videos (>= 300%):', highRatioVideos.length);

                if (highRatioVideos.length > 0) {
                    processedVideos = highRatioVideos;
                    // Sort by Ratio High to Low
                    processedVideos.sort((a, b) => b.ratio - a.ratio);
                } else {
                    // Fallback
                    console.log('No 300% ratio videos found. Showing top ratio videos instead.');
                    processedVideos.sort((a, b) => b.ratio - a.ratio);
                    if (processedVideos.length > 0) {
                        showToast('성과율 300% 이상인 영상이 없어, 성과율 높은 순으로 표시합니다.', 'info');
                    }
                }

                // Update Cache
                cachedTrendingVideos = processedVideos;
                lastTrendingFetchTime = Date.now();
                localStorage.setItem('cachedTrendingVideos', JSON.stringify(cachedTrendingVideos));
                localStorage.setItem('lastTrendingFetchTime', lastTrendingFetchTime);

                renderTrendingVideos(cachedTrendingVideos);

            } catch (error) {
                console.error('Trending load error:', error);
                showToast('인기 영상을 불러오는 중 오류가 발생했습니다: ' + error.message, 'error');
            } finally {
                loader.classList.add('hidden');
            }
        }

        function renderTrendingVideos(videos) {
            const grid = document.getElementById('trendingGrid');
            const emptyMsg = document.getElementById('emptyTrendingMessage');
            
            grid.innerHTML = '';
            
            if (videos.length === 0) {
                emptyMsg.classList.remove('hidden');
                return;
            }
            emptyMsg.classList.add('hidden');

            videos.forEach((video, index) => {
                const isHighPerformer = video.ratio >= 300;
                const ratioDisplay = video.hiddenSubs ? 'N/A' : `${video.ratio.toFixed(0)}%`;
                const ratioColor = isHighPerformer ? 'text-red-400' : 'text-green-400';
                const cardBorder = isHighPerformer ? 'border-red-500/30' : 'border-white/5';
                const glow = isHighPerformer ? 'shadow-[0_0_15px_rgba(239,68,68,0.15)]' : '';
                const timeAgoStr = timeAgo(video.publishedAt);
                const durationStr = formatDuration(video.durationSec);
                
                // Escape title and channel title for onclick handler
                const safeTitle = video.title.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const safeChannel = video.channelTitle.replace(/'/g, "\\'").replace(/"/g, "&quot;");

                const card = document.createElement('div');
                card.className = `glass-card rounded-xl overflow-hidden flex flex-col h-full ${cardBorder} ${glow} animate-fade-in`;
                card.style.animationDelay = `${index * 50}ms`;
                card.innerHTML = `
                    <div class="relative group cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">
                        <img src="${video.thumbnail}" alt="${safeTitle}" class="w-full h-48 object-cover transition-transform duration-500 group-hover:scale-105">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <i class="fa-brands fa-youtube text-red-500 text-4xl drop-shadow-lg"></i>
                        </div>
                        ${isHighPerformer ? '<div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow-lg flex items-center gap-1"><i class="fa-solid fa-fire"></i> HOT</div>' : ''}
                        <div class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded">
                            ${timeAgoStr}
                        </div>
                    </div>
                    
                    <div class="p-5 flex flex-col flex-grow">
                        <h3 class="text-lg font-bold text-white mb-2 line-clamp-2 leading-snug" title="${safeTitle}">${video.title}</h3>
                        <p class="text-gray-400 text-sm mb-4 flex items-center gap-1">
                            <i class="fa-solid fa-user-circle"></i> ${video.channelTitle}
                        </p>
                        
                        <div class="grid grid-cols-3 gap-2 mb-6 bg-black/20 rounded-lg p-3 border border-white/5">
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-1">조회수</div>
                                <div class="font-semibold text-white text-sm">${formatKoreanNumber(video.viewCount)}회</div>
                            </div>
                            <div class="text-center border-l border-white/10">
                                <div class="text-xs text-gray-500 mb-1">길이</div>
                                <div class="font-semibold text-white text-sm">${durationStr}</div>
                            </div>
                            <div class="text-center border-l border-white/10">
                                <div class="text-xs text-gray-500 mb-1">성과율</div>
                                <div class="font-bold ${ratioColor} text-sm">${ratioDisplay}</div>
                            </div>
                        </div>

                        <button onclick="openAnalysisFromFeed('${video.id}', '${safeTitle}', '${video.thumbnail}', '${safeChannel}', ${video.ratio}, ${video.hiddenSubs})" class="mt-auto w-full bg-white/5 hover:bg-blue-600 hover:text-white text-gray-300 border border-white/10 hover:border-blue-500 py-2.5 rounded-lg transition-all duration-200 font-medium flex items-center justify-center gap-2 group">
                            <i class="fa-solid fa-wand-magic-sparkles group-hover:animate-pulse"></i> AI 분석하기
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
    </script>
</body>
</html>
