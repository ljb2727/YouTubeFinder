<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Viral Finder - 소재 발굴기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            input: '#334155'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            border-color: rgba(14, 165, 233, 0.3);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #38bdf8;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            background: rgba(30, 41, 59, 0.95);
            border-left: 4px solid #38bdf8;
            color: white;
            padding: 16px 24px;
            margin-top: 10px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out forwards;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Markdown Styles */
        .prose h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; color: #93c5fd; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose p { margin-bottom: 1rem; }
        .prose strong { color: #e2e8f0; font-weight: 600; }
    </style>
</head>
<body class="min-h-screen flex flex-col relative overflow-x-hidden">

    <!-- Background Effects -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-600/20 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-600/20 rounded-full blur-[120px]"></div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-50 border-b border-white/10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="resetToHome()">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-bolt text-white text-lg"></i>
                </div>
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                    YouTube Viral Finder
                </h1>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Navigation Tabs -->
                <div class="flex bg-white/5 rounded-lg p-1 border border-white/10">
                    <button id="tabSearch" onclick="showSearchTab()" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-white bg-white/10 shadow-sm">
                        <i class="fa-solid fa-magnifying-glass mr-2"></i>검색
                    </button>
                    <button id="tabFavorites" onclick="showFavoritesTab()" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">
                        <i class="fa-solid fa-heart mr-2"></i>즐겨찾기 피드
                    </button>
                </div>

                <!-- API Settings Button -->
                <button onclick="openSettings()" class="h-10 px-4 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 flex items-center justify-center text-gray-400 hover:text-yellow-400 transition-all gap-2" title="API 키 설정">
                    <i class="fa-solid fa-key"></i> <span class="text-sm font-medium">API 설정</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-6 py-12">
        
        <!-- SEARCH TAB CONTENT -->
        <div id="searchTabContent">
            <!-- Search Section -->
            <section class="max-w-4xl mx-auto mb-16 text-center animate-fade-in">
                <h2 class="text-4xl md:text-5xl font-bold mb-6 leading-tight">
                    잠재력 있는 <span class="text-blue-400">바이럴 소재</span>를<br>발견하세요
                </h2>
                <p class="text-gray-400 mb-8 text-lg">
                    한국 유튜브 채널을 분석하여 높은 성과를 낸 영상을 찾고,<br>
                    Gemini AI로 기획 아이디어를 얻으세요.
                </p>
                
                <div class="relative max-w-3xl mx-auto group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                    <div class="relative bg-dark-card rounded-xl border border-white/10 p-2 shadow-2xl">
                        
                        <!-- Search Input -->
                        <div class="flex items-center border-b border-white/5 pb-2 mb-2">
                            <i class="fa-solid fa-magnifying-glass text-gray-400 ml-4 text-lg"></i>
                            <input type="text" id="searchInput" 
                                class="w-full bg-transparent border-none text-white px-4 py-3 focus:outline-none text-lg placeholder-gray-500"
                                placeholder="검색 키워드를 입력하세요 (예: 재테크, 요리, 운동)..."
                                onkeypress="handleEnter(event)">
                            <button onclick="searchVideos()" 
                                class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 shadow-lg shadow-blue-600/20 whitespace-nowrap">
                                <span>검색</span>
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>

                        <!-- Filters -->
                        <div class="flex flex-wrap items-center gap-6 px-6 py-4 text-sm bg-black/20 border-t border-white/5">
                            
                            <!-- Duration Filter -->
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400"><i class="fa-regular fa-clock mr-1"></i>길이:</span>
                                <select id="durationFilter" onchange="saveFilters()" class="bg-white/5 border border-white/10 rounded px-3 py-1.5 text-white focus:outline-none focus:border-blue-500 hover:bg-white/10 transition-colors">
                                    <option value="any" class="bg-slate-800">전체</option>
                                    <option value="short" class="bg-slate-800">쇼츠 (3분 미만)</option>
                                    <option value="medium" class="bg-slate-800">일반 (3분~20분)</option>
                                    <option value="long" class="bg-slate-800">롱폼 (20분 이상)</option>
                                </select>
                            </div>
                            
                            <div class="w-px h-8 bg-white/10"></div>

                            <!-- Date Filter -->
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400"><i class="fa-regular fa-calendar mr-1"></i>기간:</span>
                                <select id="dateFilter" onchange="saveFilters()" class="bg-white/5 border border-white/10 rounded px-3 py-1.5 text-white focus:outline-none focus:border-blue-500 hover:bg-white/10 transition-colors">
                                    <option value="any" class="bg-slate-800">전체</option>
                                    <option value="1d" class="bg-slate-800">최근 1일</option>
                                    <option value="7d" class="bg-slate-800">최근 7일</option>
                                    <option value="15d" class="bg-slate-800">최근 15일</option>
                                    <option value="30d" class="bg-slate-800">최근 1달</option>
                                    <option value="90d" class="bg-slate-800">최근 3개월</option>
                                </select>
                            </div>

                            <div class="w-px h-8 bg-white/10"></div>

                            <!-- Ratio Slider -->
                            <div class="flex items-center gap-4 flex-grow min-w-[200px]">
                                <span class="text-gray-400 whitespace-nowrap"><i class="fa-solid fa-chart-line mr-1"></i>최소 성과율:</span>
                                <div class="flex-grow flex flex-col gap-1">
                                    <div class="flex justify-between text-xs px-1">
                                        <span class="text-gray-500">0%</span>
                                        <span id="ratioValueLabel" class="text-blue-400 font-bold transition-all">일반 (0% 이상)</span>
                                        <span class="text-gray-500">1000%</span>
                                    </div>
                                    <input type="range" id="ratioSlider" min="0" max="100" value="0" step="5" 
                                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400 transition-all"
                                        oninput="updateRatioLabel(this.value)" onchange="saveFilters()">
                                </div>
                            </div>

                        </div>

                        <!-- Recent Searches -->
                        <div id="recentSearchSection" class="hidden px-6 py-3 bg-black/20 border-t border-white/5">
                            <div class="flex items-start md:items-center gap-3 text-sm">
                                <span class="text-gray-400 whitespace-nowrap mt-1 md:mt-0"><i class="fa-solid fa-clock-rotate-left mr-1"></i>최근 검색:</span>
                                <div id="recentSearchList" class="flex flex-wrap gap-2">
                                    <!-- Recent keywords injected here -->
                                </div>
                                <button onclick="clearRecentSearches()" class="ml-auto text-xs text-gray-500 hover:text-red-400 whitespace-nowrap mt-1 md:mt-0" title="기록 삭제">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Recommended Keywords -->
                        <div id="keywordRecommendations" class="hidden px-6 py-3 bg-black/30 border-t border-white/5 animate-fade-in">
                            <div class="flex items-start md:items-center gap-3 text-sm">
                                <span class="text-blue-400 whitespace-nowrap mt-1 md:mt-0"><i class="fa-solid fa-lightbulb mr-1"></i>추천 키워드:</span>
                                <div id="keywordList" class="flex flex-wrap gap-2">
                                    <!-- Keywords injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Loading State -->
            <div id="searchLoader" class="hidden flex flex-col items-center justify-center py-20">
                <div class="w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                <p class="text-gray-400 animate-pulse">데이터를 수집하고 분석 중입니다...</p>
            </div>

            <!-- Results Section -->
            <section id="resultsSection" class="hidden animate-slide-up">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h3 class="text-2xl font-bold text-white mb-2">검색 결과</h3>
                        <p class="text-gray-400 text-sm">설정한 필터 조건에 맞는 영상들을 성과율 순으로 보여줍니다.</p>
                    </div>
                    <div class="text-sm text-gray-500">
                        <span id="resultCount">0</span>개의 영상 발견
                    </div>
                </div>

                <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Video Cards will be injected here -->
                </div>
            </section>
        </div>

        <!-- FAVORITES TAB CONTENT -->
        <div id="favoritesTabContent" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">즐겨찾기 채널 피드</h2>
                        <p class="text-gray-400">저장한 채널들의 최신 영상을 모아봅니다.</p>
                    </div>
                    <button onclick="loadFavoritesFeed()" class="bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-lg border border-white/10 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-rotate-right"></i> 새로고침
                    </button>
                </div>

                <!-- Favorites List (Horizontal) -->
                <div id="favoritesList" class="flex gap-4 overflow-x-auto pb-4 mb-8 custom-scrollbar">
                    <!-- Favorite Channels injected here -->
                </div>

                <!-- Feed Grid -->
                <div id="feedLoader" class="hidden flex flex-col items-center justify-center py-20">
                    <div class="w-12 h-12 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-400 animate-pulse">최신 영상을 불러오는 중...</p>
                </div>

                <div id="feedGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Feed Videos injected here -->
                </div>
                
                <div id="emptyFeedMessage" class="hidden text-center py-20 text-gray-500">
                    <i class="fa-regular fa-heart text-4xl mb-4 opacity-50"></i>
                    <p>즐겨찾기한 채널이 없습니다.<br>검색 결과에서 하트 아이콘을 눌러 채널을 추가해보세요.</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Analysis Modal -->
    <div id="analysisModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-[#1e293b] w-full max-w-6xl max-h-[90vh] rounded-2xl shadow-2xl border border-white/10 flex flex-col pointer-events-auto overflow-hidden transform transition-all scale-95 opacity-0" id="modalContent">
                
                <!-- Modal Header -->
                <div class="p-6 border-b border-white/10 flex justify-between items-center bg-[#0f172a]">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-purple-500/20 text-purple-400 flex items-center justify-center">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white">AI 소재 & 스토리 분석</h3>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="flex-grow overflow-y-auto p-6 custom-scrollbar flex flex-col lg:flex-row gap-6">
                    
                    <!-- Left Column: Analysis & Ideas -->
                    <div class="w-full lg:w-5/12 flex-shrink-0 space-y-6">
                        
                        <!-- Video Info -->
                        <div class="flex gap-4 items-start">
                            <img id="modalThumbnail" src="" alt="Thumbnail" class="w-32 h-20 object-cover rounded-lg shadow-md flex-shrink-0">
                            <div>
                                <h4 id="modalTitle" class="font-bold text-white text-sm line-clamp-2 mb-1"></h4>
                                <div class="flex gap-2 text-xs text-gray-400">
                                    <span id="modalChannel"></span>
                                    <span class="text-green-400 font-bold" id="modalRatio"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Initial Loading -->
                        <div id="aiLoader" class="flex flex-col items-center justify-center py-12 bg-white/5 rounded-xl border border-white/5">
                            <div class="w-10 h-10 border-2 border-purple-500/30 border-t-purple-500 rounded-full animate-spin mb-3"></div>
                            <p class="text-sm text-gray-400 text-center animate-pulse">영상 내용과 댓글 반응을<br>분석하고 있습니다...</p>
                        </div>

                        <!-- Analysis Result Section -->
                        <div id="analysisResult" class="hidden space-y-6">
                            
                            <!-- Summary & Reactions -->
                            <div class="bg-blue-900/20 border border-blue-500/20 rounded-xl p-4">
                                <h5 class="text-blue-400 font-bold text-sm mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-align-left"></i> 영상 요약 및 반응
                                </h5>
                                <div id="aiSummary" class="text-sm text-gray-300 leading-relaxed mb-3"></div>
                                <div id="aiReactions" class="text-sm text-gray-400 leading-relaxed pl-3 border-l-2 border-white/10"></div>
                            </div>

                            <!-- Ideas List -->
                            <div>
                                <h5 class="text-purple-400 font-bold text-sm mb-3 flex items-center gap-2">
                                    <i class="fa-regular fa-lightbulb"></i> 추천 아이디어 (선택하세요)
                                </h5>
                                <div id="ideasList" class="flex flex-col gap-2">
                                    <!-- Ideas injected here -->
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column: Storyline Result -->
                    <div class="w-full lg:w-7/12 bg-black/20 rounded-xl border border-white/5 p-6 relative min-h-[500px]">
                        
                        <!-- Placeholder -->
                        <div id="storyPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 p-6 text-center">
                            <i class="fa-solid fa-book-open text-4xl mb-3 opacity-50"></i>
                            <p>왼쪽에서 아이디어를 선택하면<br>간단한 스토리라인을 보여줍니다.</p>
                        </div>

                        <!-- Story Loading -->
                        <div id="storyLoader" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-[#1e293b]/90 z-10">
                            <div class="w-12 h-12 border-4 border-green-500/30 border-t-green-500 rounded-full animate-spin mb-4"></div>
                            <p class="text-green-400 font-medium animate-pulse">스토리라인 구성 중...</p>
                        </div>

                        <!-- Story Content -->
                        <div id="storyContent" class="hidden h-full overflow-y-auto custom-scrollbar prose prose-invert max-w-none">
                            <!-- Markdown content injected here -->
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-[#1e293b] w-full max-w-md rounded-2xl shadow-2xl border border-white/10 flex flex-col transform transition-all scale-95 opacity-0" id="settingsContent">
                <div class="p-6 border-b border-white/10 flex justify-between items-center bg-[#0f172a] rounded-t-2xl">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-key text-yellow-500"></i> API 키 설정
                    </h3>
                    <button onclick="closeSettings()" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-6">
                    <p class="text-sm text-gray-400">
                        개인 API 키를 입력해야 서비스 이용이 가능합니다.<br>
                        입력된 키는 브라우저에만 저장됩니다.
                    </p>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">YouTube Data API Key</label>
                        <input type="password" id="inputYoutubeKey" class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors" placeholder="AIzaSy...">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key</label>
                        <input type="password" id="inputGeminiKey" class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors" placeholder="AIzaSy...">
                    </div>

                    <button onclick="saveApiKeys()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold transition-all shadow-lg shadow-blue-600/20">
                        저장하기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        let YOUTUBE_API_KEY = localStorage.getItem('YOUTUBE_API_KEY') || '';
        let GEMINI_API_KEY = localStorage.getItem('GEMINI_API_KEY') || '';

        // State
        let currentVideos = [];
        let currentVideoData = null;
        let favoriteChannels = JSON.parse(localStorage.getItem('favoriteChannels')) || [];
        let recentSearches = JSON.parse(localStorage.getItem('recentSearches')) || [];

        // ==========================================
        // UTILITIES
        // ==========================================
        
        const formatKoreanNumber = (num) => {
            if (num >= 100000000) return (num / 100000000).toFixed(1) + '억';
            if (num >= 10000) return (num / 10000).toFixed(1) + '만';
            if (num >= 1000) return (num / 1000).toFixed(1) + '천';
            return num.toString();
        };

        const timeAgo = (dateString) => {
            const now = new Date();
            const posted = new Date(dateString);
            const diff = now - posted;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 60) return `${minutes}분 전`;
            if (hours < 24) return `${hours}시간 전`;
            if (days < 30) return `${days}일 전`;
            if (days < 365) return `${Math.floor(days / 30)}개월 전`;
            return `${Math.floor(days / 365)}년 전`;
        };

        const parseDuration = (duration) => {
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            const hours = (parseInt(match[1]) || 0);
            const minutes = (parseInt(match[2]) || 0);
            const seconds = (parseInt(match[3]) || 0);
            return hours * 3600 + minutes * 60 + seconds;
        };

        const parseNumber = (str) => {
            if (!str) return 0;
            if (typeof str === 'number') return str;
            return parseInt(str.toString().replace(/,/g, '')) || 0;
        };

        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            let icon = 'fa-info-circle';
            let color = 'text-blue-400';
            
            if (type === 'error') {
                icon = 'fa-circle-exclamation';
                color = 'text-red-400';
                toast.style.borderLeftColor = '#ef4444';
            } else if (type === 'success') {
                icon = 'fa-check-circle';
                color = 'text-green-400';
                toast.style.borderLeftColor = '#22c55e';
            }

            toast.innerHTML = `
                <i class="fa-solid ${icon} ${color} text-xl"></i>
                <span class="font-medium">${message}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-in reverse forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        const handleEnter = (e) => {
            if (e.key === 'Enter') searchVideos();
        };

        const updateRatioLabel = (val) => {
            const ratio = val * 10;
            const label = document.getElementById('ratioValueLabel');
            
            let text = '';
            let colorClass = 'text-blue-400';

            if (ratio < 100) {
                text = '일반';
                colorClass = 'text-gray-300';
            } else if (ratio < 300) {
                text = '우수';
                colorClass = 'text-green-400';
            } else if (ratio < 500) {
                text = '대박';
                colorClass = 'text-blue-400';
            } else {
                text = '초대박';
                colorClass = 'text-purple-400';
            }

            label.className = `font-bold transition-all ${colorClass}`;
            label.innerText = `${text} (${ratio}% 이상)`;
        };

        // ==========================================
        // FILTER PERSISTENCE
        // ==========================================
        function saveFilters() {
            localStorage.setItem('filter_duration', document.getElementById('durationFilter').value);
            localStorage.setItem('filter_date', document.getElementById('dateFilter').value);
            localStorage.setItem('filter_ratio', document.getElementById('ratioSlider').value);
        }

        function loadFilters() {
            const duration = localStorage.getItem('filter_duration');
            const date = localStorage.getItem('filter_date');
            const ratio = localStorage.getItem('filter_ratio');

            if (duration) document.getElementById('durationFilter').value = duration;
            if (date) document.getElementById('dateFilter').value = date;
            if (ratio) {
                document.getElementById('ratioSlider').value = ratio;
                updateRatioLabel(ratio);
            }
        }

        // Initialize Filters & Keys & Recent Searches
        window.addEventListener('DOMContentLoaded', () => {
            loadFilters();
            checkApiKeys();
            renderRecentSearches();
        });

        // ==========================================
        // SETTINGS LOGIC
        // ==========================================
        function checkApiKeys() {
            if (!YOUTUBE_API_KEY || !GEMINI_API_KEY) {
                openSettings();
            }
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsContent');
            
            document.getElementById('inputYoutubeKey').value = YOUTUBE_API_KEY;
            document.getElementById('inputGeminiKey').value = GEMINI_API_KEY;

            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsContent');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function saveApiKeys() {
            const yKey = document.getElementById('inputYoutubeKey').value.trim();
            const gKey = document.getElementById('inputGeminiKey').value.trim();

            if (!yKey || !gKey) {
                showToast('모든 API 키를 입력해주세요.', 'error');
                return;
            }

            YOUTUBE_API_KEY = yKey;
            GEMINI_API_KEY = gKey;

            localStorage.setItem('YOUTUBE_API_KEY', YOUTUBE_API_KEY);
            localStorage.setItem('GEMINI_API_KEY', GEMINI_API_KEY);

            showToast('API 키가 저장되었습니다.', 'success');
            closeSettings();
        }

        // ==========================================
        // TAB NAVIGATION & RESET
        // ==========================================
        function resetToHome() {
            showSearchTab();
            document.getElementById('searchInput').value = '';
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('keywordRecommendations').classList.add('hidden');
            document.getElementById('videoGrid').innerHTML = '';
        }

        function showSearchTab() {
            document.getElementById('searchTabContent').classList.remove('hidden');
            document.getElementById('favoritesTabContent').classList.add('hidden');
            
            document.getElementById('tabSearch').classList.add('bg-white/10', 'text-white', 'shadow-sm');
            document.getElementById('tabSearch').classList.remove('text-gray-400');
            
            document.getElementById('tabFavorites').classList.remove('bg-white/10', 'text-white', 'shadow-sm');
            document.getElementById('tabFavorites').classList.add('text-gray-400');
        }

        function showFavoritesTab() {
            document.getElementById('searchTabContent').classList.add('hidden');
            document.getElementById('favoritesTabContent').classList.remove('hidden');
            
            document.getElementById('tabFavorites').classList.add('bg-white/10', 'text-white', 'shadow-sm');
            document.getElementById('tabFavorites').classList.remove('text-gray-400');
            
            document.getElementById('tabSearch').classList.remove('bg-white/10', 'text-white', 'shadow-sm');
            document.getElementById('tabSearch').classList.add('text-gray-400');

            loadFavoritesFeed();
        }

        // ==========================================
        // FAVORITES LOGIC
        // ==========================================
        function toggleFavorite(event, channelId, channelTitle) {
            event.stopPropagation();
            
            const index = favoriteChannels.findIndex(c => c.id === channelId);
            const isAdding = index === -1;

            if (isAdding) {
                // Add
                favoriteChannels.push({ id: channelId, title: channelTitle });
                showToast('즐겨찾기에 추가되었습니다.', 'success');
            } else {
                // Remove
                favoriteChannels.splice(index, 1);
                showToast('즐겨찾기에서 삭제되었습니다.');
            }
            
            localStorage.setItem('favoriteChannels', JSON.stringify(favoriteChannels));
            
            // Update UI if in search results
            const btn = document.getElementById(`fav-btn-${channelId}`);
            if (btn) {
                updateFavoriteBtn(btn, isAdding);
            }

            // Update UI if in favorites tab
            const favoritesTab = document.getElementById('favoritesTabContent');
            if (!favoritesTab.classList.contains('hidden')) {
                if (isAdding) {
                    // If adding while in favorites tab (unlikely but possible via console or other means), reload
                    loadFavoritesFeed();
                } else {
                    // If removing, remove elements directly to save API calls
                    const chip = document.getElementById(`fav-chip-${channelId}`);
                    if (chip) chip.remove();

                    const cards = document.querySelectorAll(`.feed-card[data-channel-id="${channelId}"]`);
                    cards.forEach(card => card.remove());

                    if (favoriteChannels.length === 0) {
                        document.getElementById('emptyFeedMessage').classList.remove('hidden');
                    }
                }
            }
        }

        function updateFavoriteBtn(btn, isFav) {
            if (isFav) {
                btn.innerHTML = '<i class="fa-solid fa-heart text-red-500"></i>';
            } else {
                btn.innerHTML = '<i class="fa-regular fa-heart text-gray-400 hover:text-red-400"></i>';
            }
        }

        function isFavorite(channelId) {
            return favoriteChannels.some(c => c.id === channelId);
        }

        async function loadFavoritesFeed() {
            const listContainer = document.getElementById('favoritesList');
            const feedGrid = document.getElementById('feedGrid');
            const emptyMsg = document.getElementById('emptyFeedMessage');
            const loader = document.getElementById('feedLoader');

            // Render Favorites List Chips
            listContainer.innerHTML = '';
            if (favoriteChannels.length === 0) {
                emptyMsg.classList.remove('hidden');
                feedGrid.innerHTML = '';
                return;
            } else {
                emptyMsg.classList.add('hidden');
            }

            favoriteChannels.forEach(ch => {
                const chip = document.createElement('div');
                chip.id = `fav-chip-${ch.id}`;
                chip.className = 'flex items-center gap-2 bg-white/5 border border-white/10 px-3 py-1.5 rounded-full whitespace-nowrap animate-fade-in';
                chip.innerHTML = `
                    <span class="text-sm text-gray-300">${ch.title}</span>
                    <button onclick="toggleFavorite(event, '${ch.id}', '${ch.title}')" class="text-gray-500 hover:text-red-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
                listContainer.appendChild(chip);
            });

            // Load Videos
            feedGrid.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                // 1. Get Uploads Playlist IDs for all favorite channels
                // Batch request: channels.list accepts up to 50 IDs
                const channelIds = favoriteChannels.map(c => c.id).join(',');
                const channelsUrl = `https://www.googleapis.com/youtube/v3/channels?part=contentDetails,snippet,statistics&id=${channelIds}&key=${YOUTUBE_API_KEY}`;
                const channelsRes = await fetch(channelsUrl);
                const channelsData = await channelsRes.json();

                if (!channelsData.items) throw new Error('채널 정보를 가져올 수 없습니다.');

                const channelMap = {};
                channelsData.items.forEach(ch => {
                    channelMap[ch.id] = ch.statistics;
                });

                // 2. Fetch latest videos from each channel's uploads playlist
                // We use Promise.all to fetch in parallel. Note: this consumes 1 quota unit per channel.
                const videoPromises = channelsData.items.map(async (channel) => {
                    const uploadsId = channel.contentDetails.relatedPlaylists.uploads;
                    const playlistUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${uploadsId}&maxResults=3&key=${YOUTUBE_API_KEY}`;
                    const plRes = await fetch(playlistUrl);
                    const plData = await plRes.json();
                    
                    return plData.items ? plData.items.map(item => ({
                        id: item.snippet.resourceId.videoId,
                        title: item.snippet.title,
                        thumbnail: item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                        channelTitle: item.snippet.channelTitle,
                        channelId: item.snippet.channelId,
                        publishedAt: item.snippet.publishedAt,
                        isFeed: true // Marker
                    })) : [];
                });

                const results = await Promise.all(videoPromises);
                let allVideos = results.flat();

                // Sort by Date Descending
                allVideos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));

                // Render Feed
                loader.classList.add('hidden');
                
                // We need to fetch view counts for these videos to show stats properly
                // But to save quota, we might skip it or do a bulk fetch. Let's do a bulk fetch.
                const videoIds = allVideos.map(v => v.id).join(',');
                if (videoIds) {
                    const statsUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
                    const statsRes = await fetch(statsUrl);
                    const statsData = await statsRes.json();
                    
                    const statsMap = {};
                    const durationMap = {};
                    if(statsData.items) {
                        statsData.items.forEach(item => {
                            statsMap[item.id] = item.statistics;
                            durationMap[item.id] = item.contentDetails.duration;
                        });
                    }

                    // Merge stats
                    allVideos = allVideos.map(v => {
                        const viewCount = parseNumber(statsMap[v.id]?.viewCount);
                        const chStats = channelMap[v.channelId];
                        const subCount = parseNumber(chStats?.subscriberCount);
                        const hiddenSubs = chStats?.hiddenSubscriberCount || false;
                        
                        let ratio = 0;
                        if (subCount > 0) {
                            ratio = (viewCount / subCount) * 100;
                        }

                        return {
                            ...v,
                            viewCount,
                            subCount,
                            hiddenSubs,
                            ratio,
                            durationSec: parseDuration(durationMap[v.id] || 'PT0S')
                        };
                    });
                }

                // Render Cards
                allVideos.forEach(video => {
                    // Reuse render logic? Let's inline for simplicity as it's slightly different
                    const timeAgoStr = timeAgo(video.publishedAt);
                    const card = document.createElement('div');
                    card.className = `glass-card rounded-xl overflow-hidden flex flex-col h-full border-white/5 animate-slide-up feed-card`;
                    card.setAttribute('data-channel-id', video.channelId);
                    
                    const isHighPerformer = video.ratio >= 300;
                    const ratioDisplay = video.hiddenSubs ? 'N/A' : `${video.ratio.toFixed(0)}%`;
                    const ratioColor = isHighPerformer ? 'text-red-400' : 'text-green-400';

                    card.innerHTML = `
                        <div class="relative group cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">
                            <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-48 object-cover transition-transform duration-500 group-hover:scale-105">
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <i class="fa-brands fa-youtube text-red-500 text-4xl drop-shadow-lg"></i>
                            </div>
                            <div class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded">
                                ${timeAgoStr}
                            </div>
                        </div>
                        
                        <div class="p-5 flex flex-col flex-grow">
                            <h3 class="text-lg font-bold text-white mb-2 line-clamp-2 leading-snug" title="${video.title}">${video.title}</h3>
                            <p class="text-gray-400 text-sm mb-4 flex items-center gap-1">
                                <i class="fa-solid fa-user-circle"></i> ${video.channelTitle}
                            </p>
                            
                            <div class="grid grid-cols-3 gap-2 mb-6 bg-black/20 rounded-lg p-3 border border-white/5">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500 mb-1">조회수</div>
                                    <div class="font-semibold text-white text-sm">${formatKoreanNumber(video.viewCount || 0)}회</div>
                                </div>
                                <div class="text-center border-l border-white/10">
                                    <div class="text-xs text-gray-500 mb-1">길이</div>
                                    <div class="font-semibold text-white text-sm">${Math.floor(video.durationSec / 60)}분</div>
                                </div>
                                <div class="text-center border-l border-white/10">
                                    <div class="text-xs text-gray-500 mb-1">성과율</div>
                                    <div class="font-bold ${ratioColor} text-sm">${ratioDisplay}</div>
                                </div>
                            </div>

                            <button onclick="openAnalysisFromFeed('${video.id}', '${video.title.replace(/'/g, "\\'")}', '${video.thumbnail}', '${video.channelTitle}', ${video.ratio}, ${video.hiddenSubs})" class="mt-auto w-full bg-white/5 hover:bg-blue-600 hover:text-white text-gray-300 border border-white/10 hover:border-blue-500 py-2.5 rounded-lg transition-all duration-200 font-medium flex items-center justify-center gap-2 group">
                                <i class="fa-solid fa-wand-magic-sparkles group-hover:animate-pulse"></i> AI 분석하기
                            </button>
                        </div>
                    `;
                    feedGrid.appendChild(card);
                });

            } catch (error) {
                console.error(error);
                showToast('피드를 불러오는 중 오류가 발생했습니다.', 'error');
                loader.classList.add('hidden');
            }
        }

        // Helper for Feed Analysis (since feed items aren't in currentVideos)
        function openAnalysisFromFeed(id, title, thumbnail, channelTitle, ratio, hiddenSubs) {
            currentVideoData = { id, title, thumbnail, channelTitle, hiddenSubs, ratio }; 
            
            // Set Modal Info
            document.getElementById('modalThumbnail').src = thumbnail;
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalChannel').innerText = channelTitle;
            document.getElementById('modalRatio').innerText = hiddenSubs ? 'N/A' : `성과율 ${ratio.toFixed(0)}%`;

            // Reset UI States
            document.getElementById('aiLoader').classList.remove('hidden');
            document.getElementById('analysisResult').classList.add('hidden');
            document.getElementById('storyPlaceholder').classList.remove('hidden');
            document.getElementById('storyContent').classList.add('hidden');
            document.getElementById('storyContent').innerHTML = '';
            
            // Show Modal
            const modal = document.getElementById('analysisModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);

            analyzeVideo(currentVideoData);
        }

        // ==========================================
        // YOUTUBE API LOGIC (SEARCH)
        // ==========================================
        async function searchVideos() {
            const query = document.getElementById('searchInput').value.trim();
            const durationFilter = document.getElementById('durationFilter').value;
            const minRatio = parseInt(document.getElementById('ratioSlider').value) * 10;
            const dateFilter = document.getElementById('dateFilter').value;

            if (!query) {
                showToast('검색어를 입력해주세요.', 'error');
                return;
            }

            // UI Reset
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('searchLoader').classList.remove('hidden');
            document.getElementById('videoGrid').innerHTML = '';
            document.getElementById('keywordRecommendations').classList.add('hidden');

            // Fetch Related Keywords (Parallel)
            fetchRelatedKeywords(query);
            
            // Save Recent Search
            saveRecentSearch(query);

            try {
                // 1. Search Videos & Channels
                let searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video,channel&maxResults=20&q=${encodeURIComponent(query)}&regionCode=KR&relevanceLanguage=ko&key=${YOUTUBE_API_KEY}`;
                
                // Apply API filters where possible (Only for videos)
                if (durationFilter !== 'any') {
                    // If duration is specified, we only search for videos
                    searchUrl = searchUrl.replace('type=video,channel', 'type=video');
                    if (durationFilter === 'short') searchUrl += `&videoDuration=short`;
                    else if (durationFilter === 'medium') searchUrl += `&videoDuration=medium`;
                    else if (durationFilter === 'long') searchUrl += `&videoDuration=long`;
                }

                if (dateFilter !== 'any') {
                    const now = new Date();
                    let daysToSubtract = 0;
                    
                    if (dateFilter === '1d') daysToSubtract = 1;
                    else if (dateFilter === '7d') daysToSubtract = 7;
                    else if (dateFilter === '15d') daysToSubtract = 15;
                    else if (dateFilter === '30d') daysToSubtract = 30;
                    else if (dateFilter === '90d') daysToSubtract = 90;

                    if (daysToSubtract > 0) {
                        const pastDate = new Date(now.setDate(now.getDate() - daysToSubtract));
                        searchUrl += `&publishedAfter=${pastDate.toISOString()}`;
                    }
                }

                const searchRes = await fetch(searchUrl);
                const searchData = await searchRes.json();

                if (!searchData.items || searchData.items.length === 0) {
                    throw new Error('검색 결과가 없습니다.');
                }

                const videoItems = searchData.items.filter(item => item.id.kind === 'youtube#video');
                const channelItems = searchData.items.filter(item => item.id.kind === 'youtube#channel');

                const videoIds = videoItems.map(item => item.id.videoId).join(',');
                
                // Collect all channel IDs (from channel results AND video results)
                const channelIdsFromVideos = videoItems.map(item => item.snippet.channelId);
                const channelIdsFromSearch = channelItems.map(item => item.id.channelId);
                const allChannelIds = [...new Set([...channelIdsFromVideos, ...channelIdsFromSearch])].join(',');

                // 2. Get Video Stats
                let videosData = { items: [] };
                if (videoIds) {
                    const videosUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
                    const videosRes = await fetch(videosUrl);
                    videosData = await videosRes.json();
                }

                // 3. Get Channel Stats
                let channelsData = { items: [] };
                if (allChannelIds) {
                    const channelsUrl = `https://www.googleapis.com/youtube/v3/channels?part=statistics,snippet&id=${allChannelIds}&key=${YOUTUBE_API_KEY}`;
                    const channelsRes = await fetch(channelsUrl);
                    channelsData = await channelsRes.json();
                }

                // 4. Merge Data
                const statsMap = {};
                const durationMap = {};
                if (videosData.items) {
                    videosData.items.forEach(item => {
                        statsMap[item.id] = item.statistics;
                        durationMap[item.id] = item.contentDetails.duration;
                    });
                }

                const channelMap = {};
                if (channelsData.items) {
                    channelsData.items.forEach(item => {
                        channelMap[item.id] = {
                            stats: item.statistics,
                            snippet: item.snippet
                        };
                    });
                }

                // Process Videos
                const processedVideos = videoItems.map(item => {
                    const vidId = item.id.videoId;
                    const chId = item.snippet.channelId;
                    const viewCount = parseNumber(statsMap[vidId]?.viewCount);
                    const subCount = parseNumber(channelMap[chId]?.stats?.subscriberCount);
                    const hiddenSubs = channelMap[chId]?.stats?.hiddenSubscriberCount || false;
                    const durationStr = durationMap[vidId] || 'PT0S';
                    const durationSec = parseDuration(durationStr);

                    let ratio = 0;
                    if (subCount > 0) {
                        ratio = (viewCount / subCount) * 100;
                    }

                    return {
                        type: 'video',
                        id: vidId,
                        title: item.snippet.title,
                        thumbnail: item.snippet.thumbnails.medium.url,
                        channelTitle: item.snippet.channelTitle,
                        channelId: chId,
                        publishedAt: item.snippet.publishedAt,
                        viewCount,
                        subCount,
                        hiddenSubs,
                        ratio,
                        durationSec
                    };
                });

                // Process Channels
                const processedChannels = channelItems.map(item => {
                    const chId = item.id.channelId;
                    const subCount = parseNumber(channelMap[chId]?.stats?.subscriberCount);
                    const videoCount = parseNumber(channelMap[chId]?.stats?.videoCount);
                    
                    return {
                        type: 'channel',
                        id: chId,
                        title: item.snippet.title,
                        thumbnail: item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                        subCount,
                        videoCount,
                        description: item.snippet.description
                    };
                });

                // Client-side Filtering for Videos
                let finalVideos = processedVideos.filter(v => {
                    if (v.ratio < minRatio) return false;
                    if (durationFilter === 'short') return v.durationSec < 180;
                    if (durationFilter === 'medium') return v.durationSec >= 180 && v.durationSec < 1200;
                    if (durationFilter === 'long') return v.durationSec >= 1200;
                    return true;
                });

                // Sort Videos by Ratio
                finalVideos.sort((a, b) => b.ratio - a.ratio);

                // Combine (Channels first, but only if filters allow)
                currentVideos = [];
                
                // Show channels only if filters are default (because channels don't have duration/ratio)
                const isDefaultFilters = durationFilter === 'any' && minRatio === 0 && dateFilter === 'any';
                
                if (isDefaultFilters) {
                    currentVideos = [...processedChannels, ...finalVideos];
                } else {
                    currentVideos = finalVideos;
                }

                renderVideos();
                document.getElementById('resultCount').innerText = currentVideos.length;
                document.getElementById('searchLoader').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');

                if (currentVideos.length === 0) {
                    showToast('조건에 맞는 결과가 없습니다.', 'error');
                }

            } catch (error) {
                console.error(error);
                document.getElementById('searchLoader').classList.add('hidden');
                showToast(error.message || 'API 호출 중 오류가 발생했습니다.', 'error');
            }
        }

        function renderVideos() {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '';

            currentVideos.forEach((item, index) => {
                const isFav = isFavorite(item.type === 'channel' ? item.id : item.channelId);
                const card = document.createElement('div');
                card.style.animationDelay = `${index * 100}ms`;
                card.classList.add('animate-slide-up');

                if (item.type === 'channel') {
                    // CHANNEL CARD
                    card.className = `glass-card rounded-xl overflow-hidden flex flex-col h-full border-purple-500/30 shadow-[0_0_15px_rgba(168,85,247,0.15)]`;
                    card.innerHTML = `
                        <div class="p-6 flex flex-col items-center text-center h-full relative">
                            <div class="absolute top-3 right-3">
                                <button onclick="toggleFavorite(event, '${item.id}', '${item.title}')" class="text-lg transition-transform hover:scale-110">
                                    ${isFav ? '<i class="fa-solid fa-heart text-red-500"></i>' : '<i class="fa-regular fa-heart text-gray-400 hover:text-red-400"></i>'}
                                </button>
                            </div>
                            
                            <div class="w-24 h-24 rounded-full overflow-hidden border-2 border-purple-500 mb-4 shadow-lg">
                                <img src="${item.thumbnail}" alt="${item.title}" class="w-full h-full object-cover">
                            </div>
                            
                            <h3 class="text-lg font-bold text-white mb-1">${item.title}</h3>
                            <p class="text-xs text-gray-400 mb-4 line-clamp-2">${item.description || '채널 설명이 없습니다.'}</p>
                            
                            <div class="grid grid-cols-2 gap-2 w-full mb-4 bg-black/20 rounded-lg p-2">
                                <div>
                                    <div class="text-xs text-gray-500">구독자</div>
                                    <div class="font-semibold text-white text-sm">${formatKoreanNumber(item.subCount)}</div>
                                </div>
                                <div class="border-l border-white/10">
                                    <div class="text-xs text-gray-500">동영상</div>
                                    <div class="font-semibold text-white text-sm">${formatKoreanNumber(item.videoCount)}개</div>
                                </div>
                            </div>

                            <button onclick="window.open('https://www.youtube.com/channel/${item.id}', '_blank')" class="mt-auto w-full bg-purple-600/20 hover:bg-purple-600 text-purple-300 hover:text-white border border-purple-500/30 py-2 rounded-lg transition-all duration-200 text-sm font-medium flex items-center justify-center gap-2">
                                <i class="fa-brands fa-youtube"></i> 채널 방문하기
                            </button>
                        </div>
                    `;
                } else {
                    // VIDEO CARD
                    const isHighPerformer = item.ratio >= 300;
                    const ratioDisplay = item.hiddenSubs ? 'N/A' : `${item.ratio.toFixed(0)}%`;
                    const ratioColor = isHighPerformer ? 'text-red-400' : 'text-green-400';
                    const cardBorder = isHighPerformer ? 'border-red-500/30' : 'border-white/5';
                    const glow = isHighPerformer ? 'shadow-[0_0_15px_rgba(239,68,68,0.15)]' : '';
                    const timeAgoStr = timeAgo(item.publishedAt);

                    card.className = `glass-card rounded-xl overflow-hidden flex flex-col h-full ${cardBorder} ${glow}`;
                    
                    card.innerHTML = `
                        <div class="relative group cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${item.id}', '_blank')">
                            <img src="${item.thumbnail}" alt="${item.title}" class="w-full h-48 object-cover transition-transform duration-500 group-hover:scale-105">
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <i class="fa-brands fa-youtube text-red-500 text-4xl drop-shadow-lg"></i>
                            </div>
                            ${isHighPerformer ? '<div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow-lg flex items-center gap-1"><i class="fa-solid fa-fire"></i> HOT</div>' : ''}
                            <div class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded">
                                ${timeAgoStr}
                            </div>
                        </div>
                        
                        <div class="p-5 flex flex-col flex-grow">
                            <h3 class="text-lg font-bold text-white mb-2 line-clamp-2 leading-snug" title="${item.title}">${item.title}</h3>
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-gray-400 text-sm flex items-center gap-1">
                                    <i class="fa-solid fa-user-circle"></i> ${item.channelTitle}
                                </p>
                                <button id="fav-btn-${item.channelId}" onclick="toggleFavorite(event, '${item.channelId}', '${item.channelTitle}')" class="text-lg transition-transform hover:scale-110">
                                    ${isFav ? '<i class="fa-solid fa-heart text-red-500"></i>' : '<i class="fa-regular fa-heart text-gray-400 hover:text-red-400"></i>'}
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 mb-6 bg-black/20 rounded-lg p-3 border border-white/5">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500 mb-1">조회수</div>
                                    <div class="font-semibold text-white text-sm">${formatKoreanNumber(item.viewCount)}회</div>
                                </div>
                                <div class="text-center border-l border-white/10">
                                    <div class="text-xs text-gray-500 mb-1">구독자</div>
                                    <div class="font-semibold text-white text-sm">${item.hiddenSubs ? '비공개' : formatKoreanNumber(item.subCount) + '명'}</div>
                                </div>
                                <div class="text-center border-l border-white/10">
                                    <div class="text-xs text-gray-500 mb-1">성과율</div>
                                    <div class="font-bold ${ratioColor} text-sm">${ratioDisplay}</div>
                                </div>
                            </div>

                            <button onclick="openAnalysis('${item.id}')" class="mt-auto w-full bg-white/5 hover:bg-blue-600 hover:text-white text-gray-300 border border-white/10 hover:border-blue-500 py-2.5 rounded-lg transition-all duration-200 font-medium flex items-center justify-center gap-2 group">
                                <i class="fa-solid fa-wand-magic-sparkles group-hover:animate-pulse"></i> AI 분석하기
                            </button>
                        </div>
                    `;
                }
                grid.appendChild(card);
            });
        }

        // ==========================================
        // ANALYSIS & GEMINI LOGIC
        // ==========================================
        
        function openAnalysis(videoId) {
            currentVideoData = currentVideos.find(v => v.id === videoId);
            
            // Set Modal Info
            document.getElementById('modalThumbnail').src = currentVideoData.thumbnail;
            document.getElementById('modalTitle').innerText = currentVideoData.title;
            document.getElementById('modalChannel').innerText = currentVideoData.channelTitle;
            document.getElementById('modalRatio').innerText = currentVideoData.hiddenSubs ? 'N/A' : `성과율 ${currentVideoData.ratio.toFixed(0)}%`;

            // Reset UI States
            document.getElementById('aiLoader').classList.remove('hidden');
            document.getElementById('analysisResult').classList.add('hidden');
            document.getElementById('storyPlaceholder').classList.remove('hidden');
            document.getElementById('storyContent').classList.add('hidden');
            document.getElementById('storyContent').innerHTML = '';
            
            // Show Modal
            const modal = document.getElementById('analysisModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);

            // Start Analysis
            analyzeVideo(currentVideoData);
        }

        function closeModal() {
            const modal = document.getElementById('analysisModal');
            const content = document.getElementById('modalContent');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        async function analyzeVideo(video) {
            try {
                // 1. Fetch Comments
                const commentsUrl = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${video.id}&maxResults=30&order=relevance&key=${YOUTUBE_API_KEY}`;
                const commentsRes = await fetch(commentsUrl);
                
                let comments = "댓글 없음";
                if (commentsRes.ok) {
                    const commentsData = await commentsRes.json();
                    if (commentsData.items) {
                        comments = commentsData.items.map(item => item.snippet.topLevelComment.snippet.textDisplay).join("\n");
                    }
                }

                // 2. Call Gemini for Summary & Ideas
                const prompt = `
                    너는 유튜브 트렌드 분석가야.
                    다음 영상의 제목과 댓글을 분석해서 3가지 정보를 JSON으로 줘.
                    
                    [영상 제목]: ${video.title}
                    [댓글]: ${comments.substring(0, 3000)}

                    요구사항:
                    1. summary: 이 영상이 어떤 내용인지 제목과 댓글로 유추해서 2문장 요약.
                    2. reactions: 시청자들이 주로 어떤 반응(재미, 유익, 공감 등)을 보였는지 2문장 요약.
                    3. ideas: 이 영상과 비슷한 주제지만 더 발전시키거나 비틀어서 만들 수 있는 '추천 아이디어 제목' 5가지 리스트.

                    반드시 JSON 형식으로만 답변해. 마크다운 쓰지 마.
                    형식: 
                    { 
                        "summary": "...", 
                        "reactions": "...", 
                        "ideas": ["아이디어1", "아이디어2", "아이디어3", "아이디어4", "아이디어5"] 
                    }
                `;

                const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                const geminiRes = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const geminiData = await geminiRes.json();
                const rawText = geminiData.candidates[0].content.parts[0].text;
                const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const result = JSON.parse(jsonText);

                renderAnalysis(result);

            } catch (error) {
                console.error(error);
                showToast('분석 중 오류가 발생했습니다.', 'error');
                document.getElementById('aiLoader').classList.add('hidden');
            }
        }

        function renderAnalysis(data) {
            // Summary & Reactions
            document.getElementById('aiSummary').innerText = data.summary;
            document.getElementById('aiReactions').innerText = data.reactions;

            // Ideas List
            const list = document.getElementById('ideasList');
            list.innerHTML = '';

            data.ideas.forEach(idea => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left px-4 py-3 rounded-lg bg-white/5 hover:bg-purple-600 hover:text-white border border-white/5 transition-all duration-200 text-sm text-gray-300 flex justify-between items-center group';
                btn.innerHTML = `
                    <span class="font-medium line-clamp-1">${idea}</span>
                    <i class="fa-solid fa-pen-nib opacity-0 group-hover:opacity-100 transition-opacity"></i>
                `;
                btn.onclick = () => generateStoryline(idea);
                list.appendChild(btn);
            });

            document.getElementById('aiLoader').classList.add('hidden');
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('analysisResult').classList.add('animate-fade-in');
        }

        async function generateStoryline(idea) {
            // UI Update
            document.getElementById('storyPlaceholder').classList.add('hidden');
            document.getElementById('storyContent').classList.add('hidden');
            document.getElementById('storyLoader').classList.remove('hidden');

            // Highlight selected idea
            const buttons = document.getElementById('ideasList').querySelectorAll('button');
            buttons.forEach(b => {
                if(b.innerText.includes(idea)) {
                    b.classList.add('bg-purple-600', 'text-white', 'border-purple-500');
                    b.classList.remove('bg-white/5', 'text-gray-300');
                } else {
                    b.classList.remove('bg-purple-600', 'text-white', 'border-purple-500');
                    b.classList.add('bg-white/5', 'text-gray-300');
                }
            });

            try {
                const prompt = `
                    너는 창의적인 스토리텔러야.
                    
                    [선택한 아이디어]: "${idea}"
                    [참고한 원본 영상]: "${currentVideoData.title}"
                    
                    위 아이디어로 영상을 만들 때 사용할 수 있는 **간단하고 매력적인 스토리라인**을 작성해줘.
                    복잡한 대본 형식이 아니라, 이야기의 흐름을 파악할 수 있는 줄거리 형태여야 해.
                    
                    [구성]
                    1. **기획 의도**: 왜 이 소재가 먹힐까? (1줄)
                    2. **도입부 (Hook)**: 시청자를 사로잡을 첫 장면이나 멘트.
                    3. **전개 (Flow)**: 이야기의 핵심 흐름 (3단계).
                    4. **결말 (Climax/Outro)**: 인상 깊은 마무리.
                    
                    출력 형식: 가독성 좋은 마크다운(Markdown).
                `;

                const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                const geminiRes = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const geminiData = await geminiRes.json();
                const storyMarkdown = geminiData.candidates[0].content.parts[0].text;

                // Render Markdown
                const contentDiv = document.getElementById('storyContent');
                contentDiv.innerHTML = marked.parse(storyMarkdown);
                
                document.getElementById('storyLoader').classList.add('hidden');
                contentDiv.classList.remove('hidden');
                contentDiv.classList.add('animate-fade-in');

            } catch (error) {
                console.error(error);
                showToast('스토리 생성 중 오류가 발생했습니다.', 'error');
                document.getElementById('storyLoader').classList.add('hidden');
            }
        }

        // ==========================================
        // KEYWORD RECOMMENDATION LOGIC
        // ==========================================
        async function fetchRelatedKeywords(query) {
            try {
                const prompt = `
                    너는 유튜브 검색 전문가야.
                    사용자가 "${query}"라는 키워드로 검색했어.
                    이와 연관성이 높고, 유튜브에서 검색량이 많을 것으로 예상되는 '추천 검색어' 6가지를 추천해줘.
                    
                    조건:
                    1. 한국어 키워드 위주로.
                    2. 너무 긴 문장보다는 검색에 실제로 쓰이는 단어 조합으로.
                    3. JSON 배열 형식으로만 출력해. (예: ["키워드1", "키워드2", ...])
                `;

                const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                const res = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                const jsonText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const keywords = JSON.parse(jsonText);

                renderRelatedKeywords(keywords);

            } catch (error) {
                console.error("Keyword fetch failed:", error);
                // Fail silently for keywords, main search is more important
            }
        }

        function renderRelatedKeywords(keywords) {
            const container = document.getElementById('keywordRecommendations');
            const list = document.getElementById('keywordList');
            
            list.innerHTML = '';
            
            if (!keywords || keywords.length === 0) return;

            keywords.forEach(k => {
                const chip = document.createElement('button');
                chip.className = 'px-3 py-1 rounded-full bg-white/5 hover:bg-blue-600/20 hover:text-blue-300 border border-white/10 hover:border-blue-500/30 text-gray-400 text-xs transition-all duration-200';
                chip.innerText = k;
                chip.onclick = () => handleKeywordClick(k);
                list.appendChild(chip);
            });

            container.classList.remove('hidden');
        }

        function handleKeywordClick(keyword) {
            document.getElementById('searchInput').value = keyword;
            searchVideos();
        }

        // ==========================================
        // RECENT SEARCH LOGIC
        // ==========================================
        function saveRecentSearch(keyword) {
            // Remove if exists (to move to top)
            recentSearches = recentSearches.filter(k => k !== keyword);
            
            // Add to top
            recentSearches.unshift(keyword);
            
            // Limit to 10
            if (recentSearches.length > 10) {
                recentSearches = recentSearches.slice(0, 10);
            }
            
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            renderRecentSearches();
        }

        function renderRecentSearches() {
            const container = document.getElementById('recentSearchSection');
            const list = document.getElementById('recentSearchList');
            
            list.innerHTML = '';
            
            if (recentSearches.length === 0) {
                container.classList.add('hidden');
                return;
            }

            recentSearches.forEach(k => {
                const chip = document.createElement('div');
                chip.className = 'flex items-center gap-2 bg-white/5 hover:bg-white/10 border border-white/10 px-2 py-1 rounded text-xs text-gray-300 transition-colors cursor-pointer group';
                chip.innerHTML = `
                    <span onclick="handleKeywordClick('${k}')">${k}</span>
                    <button onclick="deleteRecentSearch(event, '${k}')" class="text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
                list.appendChild(chip);
            });

            container.classList.remove('hidden');
        }

        function deleteRecentSearch(event, keyword) {
            event.stopPropagation();
            recentSearches = recentSearches.filter(k => k !== keyword);
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            renderRecentSearches();
        }

        function clearRecentSearches() {
            if(confirm('최근 검색 기록을 모두 삭제하시겠습니까?')) {
                recentSearches = [];
                localStorage.removeItem('recentSearches');
                renderRecentSearches();
            }
        }
    </script>
</body>
</html>
